<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motorista ‚Äì Produ√ß√£o</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- CSS GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="../menu/forms.css">
<link rel="stylesheet" href="../menu/components.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = {
  area: "trator",
  chave: "trator-motorista"
};
</script>

<script src="../login/auth-guard.js"></script>
</head>

<body style="display:none">

<div id="menu"></div>

<div class="container">

<h2>üë®‚Äçüåæ Motorista ‚Äì Produ√ß√£o</h2>

<!-- üîé FILTROS -->
<div class="card">

  <label>Motorista</label>
  <select id="filtroMotorista">
    <option value="">Todos os motoristas</option>
  </select>

  <div class="grid-2">
    <div>
      <label>M√™s</label>
      <select id="mes"></select>
    </div>

    <div>
      <label>Ano</label>
      <select id="ano"></select>
    </div>
  </div>

</div>

<!-- üìã LISTA DE SERVI√áOS -->
<div id="cards"></div>

<!-- üî¢ TOTALIZADOR -->
<div class="card destaque" id="totalizador" style="display:none">
  <strong>Total de servi√ßos:</strong> <span id="qtdServicos">0</span><br>
  <strong>Valor total dos servi√ßos:</strong> <span id="totalServicos">R$ 0,00</span><br>
  <strong>Valor bruto do motorista:</strong> <span id="totalMotorista">R$ 0,00</span>
</div>

<!-- üîô VOLTAR -->
<div class="voltar-wrapper">
  <a href="../trator/trator-inicio.html" class="btn-voltar">
    ‚Üê Voltar para Trator
  </a>
</div>

</div>

<script>
fetch("../menu/menu.html").then(r=>r.text()).then(html=>{
  document.getElementById("menu").innerHTML = html;

  document.querySelectorAll("#menu a").forEach(a=>{
    if(a.getAttribute("href")==="../trator/trator-inicio.html"){
      a.classList.add("ativo");
    }
  });

  const s=document.createElement("script");
  s.src="../menu/menu-permissoes.js";
  document.body.appendChild(s);
  document.body.style.display="block";
});
</script>

<script>
const db = firebase.firestore();

const filtroMotorista = document.getElementById("filtroMotorista");
const cards = document.getElementById("cards");

const qtdServicos = document.getElementById("qtdServicos");
const totalServicos = document.getElementById("totalServicos");
const totalMotorista = document.getElementById("totalMotorista");
const totalizador = document.getElementById("totalizador");

function moeda(v){
  return "R$ " + v.toFixed(2).replace(".",",");
}

/* üîπ MESES */
const meses = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
meses.forEach((m,i)=>mes.innerHTML+=`<option value="${i}">${m}</option>`);

const anoAtual = new Date().getFullYear();
for(let a=anoAtual-3;a<=anoAtual+5;a++){
  ano.innerHTML+=`<option>${a}</option>`;
}

mes.value = new Date().getMonth();
ano.value = anoAtual;

/* üîπ MOTORISTAS */
db.collection("motoristas").orderBy("nome_motorista").get().then(s=>{
  s.forEach(d=>{
    const m = d.data();
    filtroMotorista.innerHTML += `<option value="${m.id_motorista}">${m.nome_motorista}</option>`;
  });
});

/* üîπ CARREGAR DADOS */
function carregar(){
  cards.innerHTML="";
  totalizador.style.display="none";

  let totalValor = 0;
  let totalMotor = 0;
  let qtd = 0;

  const ini = new Date(ano.value, mes.value, 1);
  const fim = new Date(ano.value, Number(mes.value)+1, 0, 23,59,59);

  let query = db.collection("trator_servicos")
    .where("data", ">=", ini)
    .where("data", "<=", fim);

  if(filtroMotorista.value){
    query = query.where("motorista_id","==",filtroMotorista.value);
  }

  query.get().then(s=>{
    s.forEach(d=>{
      const v = d.data();
      qtd++;

      const valorServico = v.valor_total || 0;
      const valorMotorista = valorServico * 0.10;

      totalValor += valorServico;
      totalMotor += valorMotorista;

      cards.innerHTML += `
        <div class="card">
          <strong>Cliente:</strong> ${v.cliente}<br>
          <strong>Servi√ßo:</strong> ${v.tipo}<br><br>

          <strong>Valor total servi√ßo:</strong> ${moeda(valorServico)}<br><br>

          <strong>Motorista:</strong> ${v.motorista_nome || "-"}<br>
          <strong>Valor bruto motorista:</strong> ${moeda(valorMotorista)}
        </div>
      `;
    });

    if(qtd){
      qtdServicos.textContent = qtd;
      totalServicos.textContent = moeda(totalValor);
      totalMotorista.textContent = moeda(totalMotor);
      totalizador.style.display="block";
    }
  });
}

mes.onchange = ano.onchange = filtroMotorista.onchange = carregar;
carregar();
</script>

<script src="../login/logout.js"></script>

</body>
</html>