<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Financeiro do Trator</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">
<link rel="stylesheet" href="../menu/menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"trator", chave:"trator-financeiro" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --logo:#D0B485;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);color:#333}

header{background:var(--logo);padding:15px;text-align:center}
header img{max-width:260px;width:100%}

.container{max-width:900px;margin:20px auto;padding:0 15px}
h2{color:var(--marrom);display:flex;gap:8px;align-items:center}

.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
  margin-bottom:18px;
}

select{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

.grid-2x2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.metric{
  display:flex;
  gap:10px;
  align-items:center;
}

.metric .bar{
  width:6px;
  border-radius:6px;
  height:100%;
}

.metric strong{font-size:20px}
.metric span{font-size:12px;opacity:.7}

.explicativo div{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.explicativo hr{
  border:none;
  border-top:1px solid #ddd;
  margin:10px 0;
}

.mini-card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
  margin-bottom:14px;
}

.final{
  background:#efe3d3;
  text-align:center;
  font-size:20px;
  font-weight:800;
}

.btn-voltar{
  width:100%;
  padding:16px;
  border-radius:18px;
  border:2px solid var(--marrom);
  background:#fff;
  color:var(--marrom);
  font-weight:800;
}
</style>
</head>

<body style="display:none">
<header><img src="../logo.png"></header>
<div id="menu"></div>

<div class="container">
<h2>üìä Financeiro do Trator</h2>

<div class="card">
  <select id="mes"></select>
  <select id="ano"></select>
</div>

<div class="grid-2x2">
  <div class="card metric"><div class="bar" style="background:var(--verde)"></div><div><strong id="recServ">R$ 0,00</strong><span>Receita de Servi√ßos</span></div></div>
  <div class="card metric"><div class="bar" style="background:var(--vermelho)"></div><div><strong id="despTrator">R$ 0,00</strong><span>Despesas do Trator</span></div></div>
  <div class="card metric"><div class="bar" style="background:var(--vermelho)"></div><div><strong id="custoMot">R$ 0,00</strong><span>Custo Motoristas (configura√ß√£o aplicada)</span></div></div>
  <div class="card metric"><div class="bar" id="barLucro"></div><div><strong id="lucro">R$ 0,00</strong><span>Lucro do Per√≠odo</span></div></div>
</div>

<div class="card explicativo">
  <strong>üìê Composi√ß√£o do Resultado</strong>
  <div><span>Receita de Servi√ßos</span><span id="c1"></span></div>
  <div><span>(-) Despesas do Trator</span><span id="c2"></span></div>
  <div><span>(-) Motoristas</span><span id="c3"></span></div>
  <hr>
  <div><strong>Lucro L√≠quido</strong><strong id="c4"></strong></div>
</div>

<h2>üìã Servi√ßos do Per√≠odo</h2>
<div id="listaServicos"></div>

<h2>üí∏ Despesas do Trator</h2>
<div id="listaDespesas"></div>

<div class="card final" id="resultadoFinal"></div>

<button class="btn-voltar" onclick="location.href='../trator/trator-inicio.html'">‚Üê Voltar para Trator</button>
</div>

<script>
fetch("../menu/menu.html").then(r=>r.text()).then(h=>{
  menu.innerHTML=h;
  const s=document.createElement("script");
  s.src="../menu/menu-permissoes.js";
  document.body.appendChild(s);
  document.body.style.display="block";
});

const db=firebase.firestore();
const meses=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
meses.forEach((m,i)=>mes.innerHTML+=`<option value="${i}">${m}</option>`);
const anoAtual=new Date().getFullYear();
for(let a=anoAtual-2;a<=anoAtual+5;a++) ano.innerHTML+=`<option>${a}</option>`;
mes.value=new Date().getMonth(); ano.value=anoAtual;

function moeda(v){return "R$ "+v.toFixed(2).replace(".",",");}

async function carregar(){
  listaServicos.innerHTML=""; listaDespesas.innerHTML="";
  let receita=0, despesas=0, motoristas=0;

  const ini=new Date(ano.value,mes.value,1);
  const fim=new Date(ano.value,Number(mes.value)+1,0,23,59,59);

  const serv=await db.collection("trator_servicos").where("data",">=",ini).where("data","<=",fim).get();
  serv.forEach(d=>{
    const v=d.data();
    receita+=v.valor_total;
    const custo=v.valor_total*0.1;
    motoristas+=custo;
    listaServicos.innerHTML+=`
      <div class="mini-card">
        üìÖ ${v.data.toDate().toLocaleDateString("pt-BR")}<br>
        Cliente: ${v.cliente}<br>
        Servi√ßo: ${v.tipo}<br>
        Motorista: ${v.motorista_nome||"-"}<br>
        Valor: <b>${moeda(v.valor_total)}</b><br>
        Custo motorista: ${moeda(custo)}<br>
        L√≠quido estimado: ${moeda(v.valor_total-custo)}
      </div>`;
  });

  const desp=await db.collection("trator_despesas").where("data_despesa",">=",ini).where("data_despesa","<=",fim).get();
  desp.forEach(d=>{
    const v=d.data();
    despesas+=v.valor_despesa;
    listaDespesas.innerHTML+=`
      <div class="mini-card">
        üìÖ ${v.data_despesa.toDate().toLocaleDateString("pt-BR")}<br>
        Despesa: ${v.nome_despesa}<br>
        Fornecedor: ${v.fornecedor}<br>
        Valor: <b>${moeda(v.valor_despesa)}</b><br>
        Situa√ß√£o: ${v.situacao}
      </div>`;
  });

  const lucroFinal=receita-despesas-motoristas;
  recServ.textContent=moeda(receita);
  despTrator.textContent=moeda(despesas);
  custoMot.textContent=moeda(motoristas);
  lucro.textContent=moeda(lucroFinal);
  barLucro.style.background=lucroFinal>=0?"var(--verde)":"var(--vermelho)";
  c1.textContent=moeda(receita);
  c2.textContent=moeda(despesas);
  c3.textContent=moeda(motoristas);
  c4.textContent=moeda(lucroFinal);
  resultadoFinal.textContent="Resultado final do per√≠odo: "+moeda(lucroFinal);
}

mes.onchange=ano.onchange=carregar;
carregar();
</script>

<script src="../login/logout.js"></script>
</body>
</html>
