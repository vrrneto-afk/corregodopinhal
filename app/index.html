<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SÃ­tio CÃ³rrego do Pinhal</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">
<link rel="stylesheet" href="../menu/menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"app", chave:"inicio" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --laranja:#e67e22;
  --cinza:#666;
  --logo:#D0B485;
}

*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);color:#333;display:none}

header{background:var(--logo);padding:15px;text-align:center}
header img{max-width:260px;width:100%}

.container{max-width:900px;margin:20px auto;padding:0 15px}
h2{margin:28px 0 12px;color:var(--marrom)}

.clima-bar{
  background:#fff;
  padding:10px;
  border-radius:10px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
  text-align:center;
  cursor:pointer;
}

.alerta-rapido{
  display:block;
  margin:20px auto;
  padding:12px;
  border-radius:12px;
  font-weight:700;
  text-align:center;
}

.alerta-ok{background:#eaf6ec;color:var(--verde)}
.alerta-on{background:#fdecea;color:var(--vermelho)}

.card{
  background:#fff;
  padding:15px;
  margin-bottom:12px;
  border-left:6px solid;
  border-radius:12px;
}

.card.ok{border-color:var(--verde)}
.card.atencao{border-color:var(--amarelo)}
.card.alerta{border-color:var(--laranja)}
.card.atrasada{border-color:var(--vermelho)}
.card.urgente{border-color:var(--vermelho)}
.card.pendente{border-color:var(--amarelo)}

.card strong{font-size:17px;font-weight:800}
.card .dias{font-size:18px;font-weight:800;margin:6px 0}
.card .data{font-size:13px;color:var(--cinza)}
.card .msg{font-weight:700}

#clima{
  margin-bottom:10px;
}
  
</style>
</head>

<body>

<header><img src="../logo.png"></header>
<div id="menu"></div>

<div class="container">
  <div id="clima" class="clima-bar">â³ Carregando clima...</div>
  <div id="lua" class="clima-bar">ğŸŒ™ Fases da Lua</div>

  <a id="alertaRapido" href="../app/lembretes.html" class="alerta-rapido alerta-ok">
    ğŸ”” Nenhum alerta no momento
  </a>

  <div id="conteudo"></div>
</div>

<script>
const clima = document.getElementById("clima");
const luaBtn = document.getElementById("lua");
const alertaRapido = document.getElementById("alertaRapido");
const conteudo = document.getElementById("conteudo");
const db = firebase.firestore();

const hoje = new Date();
const hojeZ = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

function parseData(d){
  if (!d) return null;
  if (d.seconds) return new Date(d.seconds * 1000);
  if (typeof d === "string") {
    const p = d.split("-");
    return new Date(p[0], p[1]-1, p[2]);
  }
  return null;
}

function addMeses(d,m){
  const x = new Date(d);
  x.setMonth(x.getMonth() + m);
  return x;
}

function diffDias(a,b){
  return Math.floor((b - a) / 86400000);
}

/* ========= CACHE ========= */
function cacheGet(key, ttl){
  const c = localStorage.getItem(key);
  if(!c) return null;
  const o = JSON.parse(c);
  if(Date.now() - o.time > ttl) return null;
  return o.data;
}
function cacheSet(key, data){
  localStorage.setItem(key, JSON.stringify({ time:Date.now(), data }));
}

/* ================= MENU ================= */
fetch("../menu/menu.html")
  .then(r => r.text())
  .then(html => {
    menu.innerHTML = html;

    document.querySelectorAll("#menu a").forEach(a=>{
      if(a.getAttribute("href")==="../app/index.html"){
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => document.body.style.display = "block";
    document.body.appendChild(s);
  });

/* ================= CLIMA ================= */
async function loadClima(){
  const cache = cacheGet("clima_cache",600000);
  if(cache){
    clima.innerHTML = cache;
    return;
  }

  const snap = await db.collection("config").doc("clima").get();
  if(!snap.exists) return;
  const cfg = snap.data();

  const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${cfg.latitude}&longitude=${cfg.longitude}&current_weather=true&hourly=precipitation_probability&timezone=${cfg.timezone}`);
  const d = await r.json();

  let texto = cfg.textos?.sem_chuva || "";
  const agoraD = new Date();

  for(let i=0;i<d.hourly.time.length;i++){
    const h = new Date(d.hourly.time[i]);
    const diffMin = (h - agoraD) / 60000;
    if(diffMin>0 && diffMin<=cfg.janela_previsao_minutos && d.hourly.precipitation_probability[i]>=cfg.limite_chuva_percentual){
      texto = `${cfg.textos?.chuva_em} ${Math.round(diffMin)} minutos.`;
      break;
    }
  }

  const html = `â˜€ï¸ ${cfg.cidade} â€“ ${cfg.regiao} â€¢ ${Math.round(d.current_weather.temperature)}Â°C<br>${texto}`;
  clima.innerHTML = html;
  cacheSet("clima_cache", html);
}

/* ===== MODAL CLIMA ===== */
clima.addEventListener("click", () => {

  if (document.getElementById("modal-clima")) return;

  const overlay = document.createElement("div");
  overlay.id = "modal-clima";
  overlay.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    width:92%;
    max-width:480px;
    height:70vh;
    background:#fff;
    border-radius:14px;
    overflow:hidden;
    position:relative;
  `;

  const iframe = document.createElement("iframe");
  iframe.src = "../app/tempo.html";
  iframe.style.cssText = "width:100%;height:100%;border:none";

  box.appendChild(iframe);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  overlay.addEventListener("click", e=>{
    if(e.target===overlay) overlay.remove();
  });
});

/* ===== MODAL LUA (HTML EXTERNO) ===== */
luaBtn.addEventListener("click", () => {

  if (document.getElementById("modal-lua")) return;

  const overlay = document.createElement("div");
  overlay.id = "modal-lua";
  overlay.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    width:95%;
    max-width:520px;
    height:75vh;
    background:#fff;
    border-radius:14px;
    overflow:hidden;
    position:relative;
  `;

  const iframe = document.createElement("iframe");
  iframe.src = "../app/lua.html";
  iframe.style.cssText = "width:100%;height:100%;border:none";

  box.appendChild(iframe);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  overlay.addEventListener("click", e=>{
    if(e.target===overlay) overlay.remove();
  });
});

/* ===== FECHAR VIA postMessage ===== */
window.addEventListener("message", e => {
  if (e.data?.tipo === "fechar-clima") {
    document.getElementById("modal-clima")?.remove();
  }
  if (e.data?.tipo === "fechar-lua") {
    document.getElementById("modal-lua")?.remove();
  }
});

/* ================= ALERTAS ================= */
async function loadAlertas(){
  const s = await db.collection("lembretes").get();
  alertaRapido.className = s.size ? "alerta-rapido alerta-on" : "alerta-rapido alerta-ok";
  alertaRapido.innerText = s.size
    ? `ğŸ”” ${s.size} itens pendentes para comprar`
    : "ğŸ”” Nenhum alerta no momento";
}

/* ================= INDEX ================= */
async function loadIndex(){
  conteudo.innerHTML = "";

  const cfgVacas = cacheGet("cfg_vacas",1800000) ||
    (await db.collection("config").doc("vacas").get()).data();
  cacheSet("cfg_vacas",cfgVacas);

  const cfgVacinas = cacheGet("cfg_vacinas",1800000) ||
    (await db.collection("config").doc("vacinas").get()).data();
  cacheSet("cfg_vacinas",cfgVacinas);

  const animais = cacheGet("animais",1800000) ||
    (await db.collection("animais").get()).docs.map(d=>({_id:d.id,...d.data()}));
  cacheSet("animais",animais);

  const eventos = (await db.collection("eventos")
    .where("tipo_evento","==","cobertura").get())
    .docs.map(d=>d.data());

  const vacinas = (await db.collection("vacinas")
    .where("status","!=","Finalizada").get())
    .docs.map(d=>d.data());

  let html = "<h2>ğŸ„ Vacas a Criar</h2>";

  eventos
    .map(c=>{
      const animal = animais.find(a=>a._id===c.id_animal);
      if(!animal) return null;

      const prev = addMeses(parseData(c.data_evento), cfgVacas.gestacao_meses);
      const dias = diffDias(hojeZ, prev);
      return { animal, prev, dias };
    })
    .filter(Boolean)
    .sort((a,b)=>a.dias-b.dias)
    .forEach(v=>{
      const abs = Math.abs(v.dias);
      const regra = cfgVacas.prenhez_intervalos
        .filter(r=>r.ativa!==false && abs>=r.dias_de && abs<=r.dias_ate)
        .sort((a,b)=>a.dias_de-b.dias_de)[0];

      let texto="";
      if(v.dias>0) texto=cfgVacas.prenhez_textos?.antes_parto?.replace("{{dias}}",v.dias);
      else if(v.dias===0) texto=cfgVacas.prenhez_textos?.parto_hoje;
      else texto=cfgVacas.prenhez_textos?.parto_atrasado?.replace("{{dias}}",abs);

      html+=`
      <div class="card ${regra?.classe||"ok"}">
        <strong>ğŸ„ ${v.animal.nome.toUpperCase()}</strong>
        <p class="dias">${texto}</p>
        <p class="data">ğŸ“… ${v.prev.toLocaleDateString("pt-BR")}</p>
        ${regra?.mensagem?`<p class="msg">${regra.mensagem}</p>`:""}
      </div>`;
    });

  html += "<h2>ğŸ’‰ Vacinas pendentes</h2>";

  vacinas
    .filter(v=>v.data_aplicacao && Number(v.repeticao_dias)>0)
    .forEach(v=>{
      const reap = parseData(v.data_aplicacao);
      reap.setDate(reap.getDate()+Number(v.repeticao_dias));
      const dias = diffDias(hojeZ,reap);
      const animal = animais.find(a=>a._id===v.id_animal);
      const status = dias<0 ? "atrasada" : "pendente";

      html+=`
      <div class="card ${status}">
        <strong>ğŸ’‰ ${v.nome_vacina}</strong>
        <p class="dias">${cfgVacinas.status?.[status]} ${Math.abs(dias)} dias</p>
        <p class="data">ğŸ„ ${(animal?.nome||"-").toUpperCase()}</p>
        <p class="data">ğŸ“… ${reap.toLocaleDateString("pt-BR")}</p>
      </div>`;
    });

  conteudo.innerHTML = html;
}

/* ================= LUA VIGENTE ================= */
async function loadLuaVigente(){

  const r = await fetch("../app/luas.json");
  const dados = await r.json();

  const hoje = new Date();
  hoje.setHours(0,0,0,0);

  const luas = dados.map(l => {
    const [dia, mes, ano] = l.Data.split("/");
    return {
      ...l,
      d: new Date(Number(ano), Number(mes)-1, Number(dia))
    };
  });

  // ğŸ‘‰ lua vigente = Ãºltima lua com data <= hoje
  const vigente = luas
    .filter(l => l.d <= hoje)
    .sort((a,b) => b.d - a.d)[0];

  if(!vigente) return;

  const fase = vigente.Fase.toUpperCase();

  const emoji = {
    "NOVA":"ğŸŒ‘",
    "CRESCENTE":"ğŸŒ™",
    "CHEIA":"ğŸŒ•",
    "MINGUANTE":"ğŸŒ—"
  }[fase] || "ğŸŒ™";

  const ini = new Date(vigente.d);
  ini.setDate(ini.getDate() - 2);

  const fim = new Date(vigente.d);
  fim.setDate(fim.getDate() + 2);

 luaBtn.innerHTML = `
  Lua vigente: ${emoji} ${fase} â€¢ ${vigente.d.toLocaleDateString("pt-BR")}<br>
  ForÃ§a da lua: <small>${ini.toLocaleDateString("pt-BR")} atÃ© ${fim.toLocaleDateString("pt-BR")}</small>
`;
}

/* ================= START ================= */
(async ()=>{
  await loadClima();
  await loadLuaVigente();
  await loadAlertas();
  await loadIndex();
})();
</script>

<script src="../login/logout.js"></script>
</body>
</html>
