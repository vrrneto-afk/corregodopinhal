<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S√≠tio C√≥rrego do Pinhal</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">
<link rel="stylesheet" href="../menu/menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if(!firebase.apps.length){
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"app", chave:"inicio" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --laranja:#e67e22;
  --cinza:#666;
  --logo:#D0B485;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Arial}
body{margin:0;background:var(--bege);color:#333}
header{background:var(--logo);padding:15px 10px;text-align:center}
header img{max-width:260px;width:100%}
.container{max-width:900px;margin:20px auto;padding:0 15px}
h2{margin:28px 0 12px;color:var(--marrom)}
.clima-bar{
  background:#fff;
  margin:12px auto 16px;
  padding:10px;
  border-radius:10px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
  text-align:center;
  cursor:pointer;
}
.alerta-rapido{display:block;margin:0 auto 20px;padding:12px;border-radius:12px;font-weight:700;text-align:center}
.alerta-ok{background:#eaf6ec;color:var(--verde)}
.alerta-on{background:#fdecea;color:var(--vermelho)}
.card{background:#fff;padding:15px;margin-bottom:12px;border-left:6px solid;border-radius:12px}
.card.ok{border-color:var(--verde)}
.card.atencao{border-color:var(--amarelo)}
.card.alerta{border-color:var(--laranja)}
.card.urgente,
.card.atrasada{border-color:var(--vermelho)}
.card.pendente{border-color:var(--amarelo)}
.card strong{font-size:17px;font-weight:800}
.card .dias{font-size:18px;font-weight:800;margin:6px 0}
.card .data{font-size:13px;color:var(--cinza)}
.card .msg{font-weight:700;margin-top:4px}
</style>
</head>

<body>

<header><img src="../logo.png"></header>
<div id="menu"></div>

<div class="container">

  <div id="clima" class="clima-bar">‚è≥ Carregando clima...</div>

  <a id="alertaRapido" href="../app/lembretes.html" class="alerta-rapido alerta-ok">
    üîî Nenhum alerta no momento
  </a>

  <div id="conteudo"></div>
</div>

<script>
const menu = document.getElementById("menu");
const clima = document.getElementById("clima");
const alertaRapido = document.getElementById("alertaRapido");
const conteudo = document.getElementById("conteudo");

/* ================= MENU ================= */
fetch("../menu/menu.html")
  .then(r => r.text())
  .then(h => {
    menu.innerHTML = h;

    document.querySelectorAll("#menu a").forEach(a => {
      if (a.getAttribute("href") === "../app/index.html") {
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    document.body.appendChild(s);
  });

const db = firebase.firestore();

const hoje = new Date();
const hojeZ = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

function parseData(d){
  if(!d) return null;
  if(d.seconds) return new Date(d.seconds*1000);
  if(typeof d==="string"){
    const p=d.split("-");
    return new Date(p[0],p[1]-1,p[2]);
  }
  return null;
}
function addMeses(d,m){const x=new Date(d);x.setMonth(x.getMonth()+m);return x;}
function diffDias(a,b){return Math.floor((b-a)/86400000);}

/* ================= CLIMA ================= */
async function loadClima(){
  const cfgSnap = await db.collection("config").doc("clima").get();
  if(!cfgSnap.exists) return;

  const cfg = cfgSnap.data();

  const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${cfg.latitude}&longitude=${cfg.longitude}&current_weather=true&hourly=precipitation_probability&timezone=${cfg.timezone}`);
  const d = await r.json();

  let texto = cfg.textos?.sem_chuva || "";
  const agora = new Date();

  for(let i=0;i<d.hourly.time.length;i++){
    const h=new Date(d.hourly.time[i]);
    const diffMin=(h-agora)/60000;
    if(diffMin>0 && diffMin<=cfg.janela_previsao_minutos && d.hourly.precipitation_probability[i]>=cfg.limite_chuva_percentual){
      texto = `${cfg.textos?.chuva_em || ""} ${Math.round(diffMin)} minutos.`;
      break;
    }
  }

  clima.innerHTML = `‚òÄÔ∏è ${cfg.cidade} ‚Äì ${cfg.regiao} ‚Ä¢ ${Math.round(d.current_weather.temperature)}¬∞C<br>${texto}`;
}

/* ===== MODAL CLIMA (RESTAURADO) ===== */
clima.addEventListener("click", () => {
  if(document.getElementById("modal-clima")) return;

  const overlay = document.createElement("div");
  overlay.id = "modal-clima";
  overlay.style = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const box = document.createElement("div");
  box.style = `
    width:95%;
    max-width:520px;
    max-height:90%;
    background:#fff;
    border-radius:14px;
    overflow:auto;
  `;

  fetch("../app/tempo.html")
    .then(r => r.text())
    .then(html => {
      box.innerHTML = html;
      overlay.appendChild(box);
      document.body.appendChild(overlay);
    });

  overlay.addEventListener("click", e => {
    if(e.target === overlay){
      overlay.remove();
    }
  });
});

/* ================= ALERTAS ================= */
async function loadAlertas(){
  const s=await db.collection("lembretes").get();
  alertaRapido.className = s.size ? "alerta-rapido alerta-on" : "alerta-rapido alerta-ok";
  alertaRapido.innerText = s.size ? `üîî ${s.size} itens pendentes para comprar` : "üîî Nenhum alerta no momento";
}

/* ================= INDEX ================= */
async function loadIndex(){
  conteudo.innerHTML="";

  const cfgVacas = (await db.collection("config").doc("vacas").get()).data();
  const cfgVacinas = (await db.collection("config").doc("vacinas").get()).data();

  const animais = (await db.collection("animais").get()).docs.map(d=>({_id:d.id,...d.data()}));
  const eventos = (await db.collection("eventos").get()).docs.map(d=>d.data());
  const vacinas = (await db.collection("vacinas").get()).docs.map(d=>d.data());

  /* ===== VACAS ===== */
  conteudo.innerHTML += "<h2>üêÑ Vacas a Criar</h2>";

  eventos
    .filter(e => e.tipo_evento === "cobertura")
    .map(c => {
      const prev = addMeses(parseData(c.data_evento), cfgVacas.gestacao_meses);
      const dias = diffDias(hojeZ, prev);
      return {
        animal: animais.find(a => a._id === c.id_animal),
        prev,
        dias
      };
    })
    .filter(x => x.animal)
    .sort((a, b) => a.dias - b.dias)
    .forEach(v => {

      const diasAbs = Math.abs(v.dias);

      let regra = cfgVacas.prenhez_intervalos
        .filter(r =>
          r.ativa !== false &&
          diasAbs >= r.dias_de &&
          diasAbs <= r.dias_ate
        )
        .sort((a, b) => a.dias_de - b.dias_de)[0];

      let textoPrenhez = "";

      if (v.dias > 0) {
        textoPrenhez = cfgVacas.prenhez_textos?.antes_parto
          ?.replace("{{dias}}", v.dias);
      }
      else if (v.dias === 0) {
        textoPrenhez = cfgVacas.prenhez_textos?.parto_hoje;
      }
      else {
        textoPrenhez = cfgVacas.prenhez_textos?.parto_atrasado
          ?.replace("{{dias}}", diasAbs);
      }

      conteudo.innerHTML += `
        <div class="card ${regra?.classe || "ok"}">
          <strong>üêÑ ${v.animal.nome.toUpperCase()}</strong>
          <p class="dias">${textoPrenhez}</p>
          <p class="data">üìÖ ${v.prev.toLocaleDateString("pt-BR")}</p>
          ${regra?.mensagem ? `<p class="msg">${regra.mensagem}</p>` : ""}
        </div>
      `;
    });

  /* ===== VACINAS ===== */
  conteudo.innerHTML += "<h2>üíâ Vacinas pendentes</h2>";

  vacinas
    .filter(v =>
      v.data_aplicacao &&
      Number(v.repeticao_dias) > 0 &&
      v.status !== "Finalizada"
    )
    .map(v => {
      const reap = parseData(v.data_aplicacao);
      reap.setDate(reap.getDate() + Number(v.repeticao_dias));
      return {
        ...v,
        reap,
        dias: diffDias(hojeZ, reap)
      };
    })
    .sort((a, b) => a.dias - b.dias)
    .forEach(v => {

      const animal = animais.find(a => a._id === v.id_animal);

      const status = v.dias < 0
        ? "atrasada"
        : "pendente";

      conteudo.innerHTML += `
        <div class="card ${status}">
          <strong>üíâ ${v.nome_vacina}</strong>
          <p class="dias">
            ${cfgVacinas.status?.[status]}
            ${Math.abs(v.dias)} dias
          </p>
          <p class="data">üêÑ ${(animal?.nome || "-").toUpperCase()}</p>
          <p class="data">üìÖ ${v.reap.toLocaleDateString("pt-BR")}</p>
        </div>
      `;
    });
}

loadClima();
loadAlertas();
loadIndex();
</script>

<script src="../login/logout.js"></script>
</body>
</html>