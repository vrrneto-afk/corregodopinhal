<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fases da Lua</title>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --cinza:#666;
  --borda:#e5e5e5;
}

*{
  box-sizing:border-box;
  font-family:Inter,system-ui,Arial;
}

body{
  margin:0;
  background:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
.header{
  padding:14px 16px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:800;
  color:var(--marrom);
}

.header .fechar{
  cursor:pointer;
  font-size:20px;
}

/* ===== CONTE√öDO ===== */
.conteudo{
  flex:1;
  overflow:auto;
  padding:12px;
  background:var(--bege);
}

/* ===== CARD LUA ===== */
.card-lua{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  border:1px solid var(--borda);
}

.card-topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card-topo strong{
  color:var(--marrom);
}

.fase{
  margin-top:6px;
  font-weight:800;
}

.forca{
  margin-top:4px;
  font-size:13px;
  color:var(--cinza);
}

/* ===== FOOTER ===== */
.footer{
  border-top:1px solid #ddd;
  padding:14px;
  background:#fff;
}

.footer button{
  width:100%;
  border:1px solid var(--marrom);
  border-radius:10px;
  padding:12px;
  font-weight:700;
  background:#fff;
  color:var(--marrom);
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <span>üåô Fases da Lua</span>
  <span class="fechar" onclick="fechar()">‚úï</span>
</div>

<!-- ===== CONTE√öDO ===== -->
<div id="conteudo" class="conteudo">
  ‚è≥ Carregando fases da lua...
</div>

<!-- ===== FOOTER ===== -->
<div class="footer">
  <button onclick="fechar()">Fechar</button>
</div>

<script>
function fechar(){
  window.parent.postMessage({ tipo:"fechar-lua" }, "*");
}

/* ===== FASE POR FRA√á√ÉO ===== */
function fasePorFracao(f){
  if (f < 0.125 || f >= 0.875) return "üåë LUA NOVA";
  if (f < 0.375) return "üåì LUA CRESCENTE";
  if (f < 0.625) return "üåï LUA CHEIA";
  return "üåó LUA MINGUANTE";
}

/* ===== CARREGAR LUAS ===== */
async function carregarLuas(){

  const cont = document.getElementById("conteudo");
  cont.innerHTML = "";

  const lat = -19.9;
  const lon = -44.5;

  const hoje = new Date();
  const fim = new Date();
  fim.setDate(hoje.getDate() + 30);

  const iniStr = hoje.toISOString().split("T")[0];
  const fimStr = fim.toISOString().split("T")[0];

  const url =
    `https://api.open-meteo.com/v1/astronomy` +
    `?latitude=${lat}` +
    `&longitude=${lon}` +
    `&daily=moon_phase` +          // üî¥ ESTA LINHA FALTAVA
    `&start_date=${iniStr}` +
    `&end_date=${fimStr}` +
    `&timezone=America/Sao_Paulo`;

  const r = await fetch(url);
  const d = await r.json();

  if(!d.daily || !d.daily.moon_phase){
    cont.innerHTML = "N√£o foi poss√≠vel carregar as fases da lua.";
    return;
  }

  const fases = d.daily.moon_phase;
  const datas = d.daily.time;

  const principais = [];

  for(let i=0;i<fases.length && principais.length<4;i++){
    const f = fases[i];

    if(
      f < 0.02 ||
      Math.abs(f-0.25)<0.03 ||
      Math.abs(f-0.5)<0.03 ||
      Math.abs(f-0.75)<0.03
    ){
      principais.push({
        fase: fasePorFracao(f),
        data: datas[i]
      });
    }
  }

  principais.forEach(l => {

    const d = new Date(l.data);
    const dia = d.toLocaleDateString("pt-BR",{weekday:"short"}).toUpperCase();
    const dataFmt = d.toLocaleDateString("pt-BR");

    const ini = new Date(d);
    ini.setDate(d.getDate() - 2);

    const fim = new Date(d);
    fim.setDate(d.getDate() + 2);

    cont.innerHTML += `
      <div class="card-lua">
        <div class="card-topo">
          <strong>${dia}</strong>
          <span>üìÖ ${dataFmt}</span>
        </div>

        <div class="fase">
          ${l.fase}
        </div>

        <div class="forca">
          For√ßa da Lua:
          ${ini.toLocaleDateString("pt-BR")} at√© ${fim.toLocaleDateString("pt-BR")}
        </div>
      </div>
    `;
  });
}

carregarLuas();
</script>

</body>
</html>
