<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fases da Lua</title>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --cinza:#666;
  --borda:#e5e5e5;
}

*{
  box-sizing:border-box;
  font-family:Inter,system-ui,Arial;
}

body{
  margin:0;
  background:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
.header{
  padding:14px 16px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:800;
  color:var(--marrom);
}

.header .fechar{
  cursor:pointer;
  font-size:20px;
}

/* ===== CONTE√öDO ===== */
.conteudo{
  flex:1;
  overflow:auto;
  padding:12px;
  background:var(--bege);
}

/* ===== CARD LUA ===== */
.card-lua{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  border:1px solid var(--borda);
}

.card-topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card-topo strong{
  color:var(--marrom);
}

.fase{
  margin-top:6px;
  font-weight:800;
}

.forca{
  margin-top:4px;
  font-size:13px;
  color:var(--cinza);
}

/* ===== FOOTER ===== */
.footer{
  border-top:1px solid #ddd;
  padding:14px;
  background:#fff;
}

.footer button{
  width:100%;
  border:1px solid var(--marrom);
  border-radius:10px;
  padding:12px;
  font-weight:700;
  background:#fff;
  color:var(--marrom);
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <span>üåô Fases da Lua</span>
  <span class="fechar" onclick="fechar()">‚úï</span>
</div>

<!-- ===== CONTE√öDO ===== -->
<div id="conteudo" class="conteudo">
  ‚è≥ Carregando fases da lua...
</div>

<!-- ===== FOOTER ===== -->
<div class="footer">
  <button onclick="fechar()">Fechar</button>
</div>

<script>
function fechar(){
  window.parent.postMessage({ tipo:"fechar-lua" }, "*");
}

/* ================= UTIL ================= */
const DEG2RAD = Math.PI / 180;

function sin(d){ return Math.sin(d * DEG2RAD); }
function cos(d){ return Math.cos(d * DEG2RAD); }

/* ===== CONVERTE JD PARA DATE ===== */
function jdToDate(jd){
  const Z = Math.floor(jd + 0.5);
  const F = (jd + 0.5) - Z;
  let A = Z;
  if (Z >= 2299161) {
    const alpha = Math.floor((Z - 1867216.25) / 36524.25);
    A = Z + 1 + alpha - Math.floor(alpha / 4);
  }
  const B = A + 1524;
  const C = Math.floor((B - 122.1) / 365.25);
  const D = Math.floor(365.25 * C);
  const E = Math.floor((B - D) / 30.6001);

  const day = B - D - Math.floor(30.6001 * E) + F;
  const month = (E < 14) ? E - 1 : E - 13;
  const year = (month > 2) ? C - 4716 : C - 4715;

  const dayInt = Math.floor(day);
  const frac = day - dayInt;

  const h = frac * 24;
  const m = (h - Math.floor(h)) * 60;

  return new Date(
    year,
    month - 1,
    dayInt,
    Math.floor(h),
    Math.floor(m)
  );
}

/* ===== FASES DA LUA (MEEUS) ===== */
function faseLuaMeeus(k, fase){
  const T = k / 1236.85;
  const T2 = T*T;
  const T3 = T2*T;

  let jd = 2451550.09765 +
    29.530588853 * k +
    0.0001337 * T2 -
    0.000000150 * T3 +
    0.00000000073 * T*T3;

  const M  = 2.5534 + 29.10535669 * k - 0.0000218 * T2;
  const M1 = 201.5643 + 385.81693528 * k + 0.0107438 * T2;
  const F  = 160.7108 + 390.67050284 * k - 0.0016341 * T2;
  const Œ©  = 124.7746 - 1.56375588 * k + 0.0020672 * T2;

  const E = 1 - 0.002516 * T - 0.0000074 * T2;

  if (fase === "nova" || fase === "cheia") {
    jd +=
      -0.40720 * sin(M1) +
       0.17241 * E * sin(M) +
       0.01608 * sin(2*M1) +
       0.01039 * sin(2*F) +
       0.00739 * E * sin(M1 - M) -
       0.00514 * E * sin(M1 + M);

    if (fase === "cheia") jd += 0.5;
  }

  if (fase === "crescente" || fase === "minguante") {
    jd +=
      -0.62801 * sin(M1) +
       0.17172 * E * sin(M) -
       0.01183 * E * sin(M1 + M) +
       0.00862 * sin(2*M1);

    jd += (fase === "crescente" ? 0.25 : 0.75);
  }

  return jd;
}

/* ===== CARREGAR LUAS ===== */
function carregarLuas(){

  const cont = document.getElementById("conteudo");
  cont.innerHTML = "";

  const hoje = new Date();
  const ano = hoje.getFullYear();
  const k0 = Math.floor((ano - 2000) * 12.3685);

  const fases = [];
  let k = k0;

  while (fases.length < 4) {
    ["nova","crescente","cheia","minguante"].forEach(f => {
      const d = jdToDate(faseLuaMeeus(k, f));
      if (d >= hoje && fases.length < 4) {
        fases.push({ data:d, fase:f });
      }
    });
    k++;
  }

  const nomeFase = {
    nova: "üåë LUA NOVA",
    crescente: "üåì LUA CRESCENTE",
    cheia: "üåï LUA CHEIA",
    minguante: "üåó LUA MINGUANTE"
  };

  fases.forEach(l => {

    const d = l.data;
    const dia = d.toLocaleDateString("pt-BR",{weekday:"short"}).toUpperCase();
    const dataFmt = d.toLocaleDateString("pt-BR");

    const ini = new Date(d);
    ini.setDate(d.getDate() - 2);

    const fim = new Date(d);
    fim.setDate(d.getDate() + 2);

    cont.innerHTML += `
      <div class="card-lua">
        <div class="card-topo">
          <strong>${dia}</strong>
          <span>üìÖ ${dataFmt}</span>
        </div>

        <div class="fase">
          ${nomeFase[l.fase]}
        </div>

        <div class="forca">
          For√ßa da Lua:
          ${ini.toLocaleDateString("pt-BR")} at√© ${fim.toLocaleDateString("pt-BR")}
        </div>
      </div>
    `;
  });
}

carregarLuas();
</script>

</body>
</html>
