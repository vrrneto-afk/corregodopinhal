<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fases da Lua</title>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --cinza:#666;
  --borda:#e5e5e5;
}

*{ box-sizing:border-box; font-family:Inter,system-ui,Arial }

body{
  margin:0;
  background:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header{
  padding:14px 16px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:800;
  color:var(--marrom);
}
.header .fechar{ cursor:pointer; font-size:20px }

/* CONTEÃšDO */
.conteudo{
  flex:1;
  overflow:auto;
  padding:12px;
  background:var(--bege);
}

/* LUA VIGENTE */
.lua-vigente{
  background:#fff;
  border:1px solid var(--borda);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}

.lua-vigente .titulo{
  font-weight:800;
  color:var(--marrom);
  margin-bottom:6px;
}

.lua-vigente .atual{
  font-weight:700;
  color:#333;
}

/* CARD */
.card-lua{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  border:1px solid var(--borda);
}

.card-topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card-topo strong{
  color:var(--marrom);
  font-weight:800;
}

.fase{
  margin-top:6px;
  font-weight:800;
  font-size:15px;
}

.forca{
  margin-top:4px;
  font-size:13px;
  color:var(--cinza);
}

/* FOOTER */
.footer{
  border-top:1px solid #ddd;
  padding:14px;
  background:#fff;
}
.footer button{
  width:100%;
  border:1px solid var(--marrom);
  border-radius:10px;
  padding:12px;
  font-weight:700;
  background:#fff;
  color:var(--marrom);
  cursor:pointer;
}
</style>
</head>

<body>

<div class="header">
  <span>ğŸŒ™ Fases da Lua</span>
  <span class="fechar" onclick="fechar()">âœ•</span>
</div>

<div id="conteudo" class="conteudo">
  â³ Carregando fases da lua...
</div>

<div class="footer">
  <button onclick="fechar()">Fechar</button>
</div>

<script>
function fechar(){
  window.parent.postMessage({ tipo:"fechar-lua" }, "*");
}

/* ===== CARREGAR LUAS ===== */
async function carregarLuas(){

  const cont = document.getElementById("conteudo");
  cont.innerHTML = "";

  const r = await fetch("./luas.json");
  const dados = await r.json();

  const hoje = new Date();
  hoje.setHours(0,0,0,0);

  const luas = dados.map(l => {
    const [dia, mes, ano] = l.Data.split("/");
    return {
      ...l,
      d: new Date(`${ano}-${mes}-${dia}`)
    };
  });

  /* LUA VIGENTE */
  const passadas = luas
    .filter(l => l.d <= hoje)
    .sort((a,b) => b.d - a.d);

  const atual = passadas[0];

  if(atual){
    const emoji = {
      "Lua Nova":"ğŸŒ‘",
      "Lua Crescente":"ğŸŒ’",
      "Lua Cheia":"ğŸŒ•",
      "Lua Minguante":"ğŸŒ—",
      "NOVA":"ğŸŒ‘",
      "CRESCENTE":"ğŸŒ’",
      "CHEIA":"ğŸŒ•",
      "MINGUANTE":"ğŸŒ—"
    }[atual.Fase] || "ğŸŒ™";

    cont.innerHTML += `
      <div class="lua-vigente">
        <div class="titulo">ğŸŒ™ Fases da Lua</div>
        <div class="atual">
          Lua vigente: ${emoji} ${atual.Fase} â€¢ ${atual.d.toLocaleDateString("pt-BR")}
        </div>
      </div>
    `;
  }

  /* PRÃ“XIMAS FASES */
  const futuras = luas
    .filter(l => l.d >= hoje)
    .slice(0,4);

  futuras.forEach(l => {

    const dia = l.d.toLocaleDateString("pt-BR",{weekday:"short"}).toUpperCase();
    const dataFmt = l.d.toLocaleDateString("pt-BR");

    const ini = new Date(l.d);
    ini.setDate(l.d.getDate()-2);

    const fim = new Date(l.d);
    fim.setDate(l.d.getDate()+2);

    cont.innerHTML += `
      <div class="card-lua">
        <div class="card-topo">
          <strong>${dia}</strong>
          <span>ğŸ“… ${dataFmt}</span>
        </div>

        <div class="fase">
          ${l.Fase}
        </div>

        <div class="forca">
          ForÃ§a da Lua: ${ini.toLocaleDateString("pt-BR")} atÃ© ${fim.toLocaleDateString("pt-BR")}
        </div>
      </div>
    `;
  });
}

carregarLuas();
</script>

</body>
</html>
