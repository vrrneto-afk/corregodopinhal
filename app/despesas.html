<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RelatÃ³rios â€“ SÃ­tio CÃ³rrego do Pinhal</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- CSS DO CONFIG (apenas para o corpo/cards) -->
<link rel="stylesheet" href="../config/config.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- IDENTIFICAÃ‡ÃƒO DA PÃGINA -->
<script>
window.PERMISSAO_PAGINA = {
  area: "app",
  chave: "relatorios"
};
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
/* ğŸ¯ GARANTE IDENTIDADE VISUAL DO APP */
body{
  margin:0;
  background:var(--bege,#f6efe7);
  color:#333;
}
</style>
</head>

<body style="display:none">

<!-- HEADER PADRÃƒO DO APP -->
<header>
  <img src="../logo.png" alt="SÃ­tio CÃ³rrego do Pinhal">
</header>

<!-- MENU APP -->
<div id="menu"></div>

<!-- CONTEÃšDO -->
<div class="container">

  <h2>ğŸ“Š RelatÃ³rios</h2>

  <div class="cards-grid">

    <button class="config-card" data-permissao="relatorio-financeiro"
      onclick="location.href='relatorio-financeiro.html'">
      ğŸ’° <span>Financeiro</span>
    </button>

    <button class="config-card" data-permissao="relatorio-leite"
      onclick="location.href='relatorio-leite.html'">
      ğŸ¥› <span>Leite</span>
    </button>

    <button class="config-card" data-permissao="relatorio-rebanho"
      onclick="location.href='relatorio-rebanho.html'">
      ğŸ„ <span>Rebanho</span>
    </button>

    <button class="config-card" data-permissao="relatorio-sanitario"
      onclick="location.href='relatorio-sanitario.html'">
      ğŸ’‰ <span>SanitÃ¡rio</span>
    </button>

  </div>
</div>

<script>
/* MENU DO APP â€“ PADRÃƒO DEFINITIVO */
fetch("../menu/menu.html")
  .then(r => r.text())
  .then(h => {
    const menu = document.getElementById("menu");
    menu.innerHTML = h;

    document.querySelectorAll("#menu a").forEach(a=>{
      if(a.getAttribute("href")?.includes("relatorios.html")){
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = filtrarCardsRelatorios;
    document.body.appendChild(s);
  });

async function filtrarCardsRelatorios(){
  const user = firebase.auth().currentUser;
  if(!user) return;

  const snap = await firebase.firestore()
    .collection("usuarios")
    .doc(user.uid)
    .get();

  if(!snap.exists) return;

  const papel = snap.data().papel;
  if(!papel) return;

  const grupoSnap = await firebase.firestore()
    .collection("config")
    .doc("grupos")
    .get();

  if(!grupoSnap.exists) return;

  const grupo = grupoSnap.data().lista.find(g => g.id === papel);
  if(!grupo) return;

  const permissoesApp = grupo.permissoes?.app || {};

  document.querySelectorAll(".config-card").forEach(card=>{
    const chave = card.dataset.permissao;
    if(!permissoesApp.tudo && !permissoesApp[chave]){
      card.remove();
    }
  });

  document.body.style.display = "block";
}
</script>

<!-- LOGOUT GLOBAL -->
<script src="../login/logout.js"></script>

</body>
</html>