<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vacinas ‚Äì S√≠tio C√≥rrego do Pinhal</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- FIREBASE LIBS -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- FIREBASE INIT -->
<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<!-- IDENTIFICA√á√ÉO DA P√ÅGINA -->
<script>
window.PERMISSAO_PAGINA = { area:"app", chave:"vacinas" };
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#c0392b;
  --amarelo:#e0a800;
  --cinza:#666;
  --logo:#D0B485;
}

*{
  box-sizing:border-box;
  font-family:'Inter',system-ui,Arial;
}

body{
  margin:0;
  background:var(--bege);
  color:#333;
  display:none;
}

header{
  background:var(--logo);
  padding:15px;
  text-align:center;
}

header img{
  max-width:260px;
  width:100%;
}

.container{
  max-width:900px;
  margin:20px auto;
  padding:0 15px;
}

h2{
  margin:25px 0;
  color:var(--marrom);
}

select{
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border-radius:10px;
  border:1.5px solid #ddd;
}

.vazio{
  text-align:center;
  color:#777;
  font-style:italic;
  margin-top:30px;
}
</style>
</head>

<body>

<header>
  <img src="../logo.png">
</header>

<div id="menu"></div>

<div class="container">
  <h2>üíâ Vacinas</h2>

  <select id="filtro">
    <option value="todas">Hist√≥rico completo</option>
    <option value="atrasada">Atrasadas</option>
    <option value="pendente">Pendentes</option>
    <option value="finalizada">Finalizadas</option>
  </select>

  <div id="lista"></div>
</div>

<!-- MENU + PERMISS√ïES (PADR√ÉO DEFINITIVO) -->
<script>
fetch("../menu/menu.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu").innerHTML = html;

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";

    s.onload = () => {
      document.querySelectorAll(".menu-link").forEach(link=>{
        if(link.dataset.area==="app" && link.dataset.chave==="vacinas"){
          link.classList.add("ativo");
        }
      });

      document.body.style.display = "block";
      iniciarPagina();
    };

    document.body.appendChild(s);
  });
</script>

<script>
const db = firebase.firestore();
const lista = document.getElementById("lista");

let CONFIG = {
  prioridades:{atrasada:1,pendente:2,finalizada:3},
  status:{atrasada:"Atrasada",pendente:"Reaplicar",finalizada:"Finalizada"}
};

function parseDate(v){
  if(v?.seconds) return new Date(v.seconds*1000);
  if(typeof v==="string") return new Date(v+"T00:00:00");
  return new Date(v);
}

function diffDias(a,b){
  return Math.ceil((b-a)/86400000);
}

async function iniciarPagina(){
  const cfg = await db.collection("config").doc("vacinas").get();
  if(cfg.exists) CONFIG = {...CONFIG, ...cfg.data()};

  const snap = await db.collection("vacinas").get();
  const VACINAS = snap.docs.map(d=>d.data());

  const hoje = new Date();
  hoje.setHours(0,0,0,0);

  function render(filtro){
    lista.innerHTML="";
    let cards=[];

    VACINAS.forEach(v=>{
      const aplicada = parseDate(v.data_aplicacao);
      const repeticao = Number(v.repeticao_dias || 0);

      let status, classe, badge, texto, grupo, ordem;

      if(v.status==="Finalizada"){
        status="finalizada";
        classe="finalizada";
        badge=`<span class="badge finalizada-b">${CONFIG.status.finalizada}</span>`;
        grupo=CONFIG.prioridades.finalizada;
        ordem=aplicada;
      }else{
        const reaplicar = new Date(aplicada);
        reaplicar.setDate(reaplicar.getDate()+repeticao);
        const dias = diffDias(hoje, reaplicar);

        if(dias < 0){
          status="atrasada";
          classe="atrasada";
          badge=`<span class="badge atrasada-b">${CONFIG.status.atrasada}</span>`;
          texto=`‚ö†Ô∏è ${CONFIG.status.atrasada} h√° ${Math.abs(dias)} dias`;
          grupo=CONFIG.prioridades.atrasada;
          ordem=dias;
        }else{
          status="pendente";
          classe="pendente";
          badge=`<span class="badge pendente-b">${CONFIG.status.pendente}</span>`;
          texto=`‚è≥ ${CONFIG.status.pendente} em ${dias} dias`;
          grupo=CONFIG.prioridades.pendente;
          ordem=dias;
        }
      }

      if(filtro!=="todas" && filtro!==status) return;

      cards.push({
        grupo, ordem,
        html:`
        <div class="card-vacina ${classe}">
          <strong>üíâ ${v.nome_vacina || "Vacina"}</strong>
          <p>üêÑ ${(v.nome_animal || "-").toUpperCase()}</p>
          ${badge}
          ${texto ? `<p>${texto}</p>` : ""}
          <p>Aplicada em: ${aplicada.toLocaleDateString("pt-BR")}</p>
        </div>`
      });
    });

    cards
      .sort((a,b)=>a.grupo-b.grupo || a.ordem-b.ordem)
      .forEach(c=>lista.innerHTML+=c.html);

    if(!cards.length){
      lista.innerHTML=`<div class="vazio">üíâ Nenhuma vacina encontrada.</div>`;
    }
  }

  filtro.onchange = e => render(e.target.value);
  render("todas");
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>