<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Despesas ‚Äì ADM</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
</script>

<script>
window.PERMISSAO_PAGINA = {
  area:"adm",
  chave:"cadastro_despesas"
};
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#b03a2e;
  --logo:#D0B485;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

body{
  margin:0;
  background:var(--bege);
  color:#333;
  display:none;
}

header{
  background:var(--logo);
  padding:14px;
  text-align:center;
  font-weight:800;
  font-size:17px;
}

.container{
  max-width:760px;
  margin:16px auto;
  padding:16px;
  background:#fff;
  border-radius:12px;
}

label{
  font-weight:600;
  margin-top:10px;
  display:block;
  font-size:14px;
}

input,select,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:4px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

textarea{resize:vertical}

button{
  width:100%;
  padding:12px;
  margin-top:14px;
  border:none;
  font-size:15px;
  cursor:pointer;
  border-radius:10px;
}

.salvar{background:var(--verde);color:#fff}
.excluir{background:var(--vermelho);color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<header>üí∞ Cadastro de Despesas</header>

<div id="menu-adm"></div>

<div class="container">

<label>A√ß√£o</label>
<select id="acao">
  <option value="novo">‚ûï Novo registro</option>
  <option value="editar">‚úèÔ∏è Editar registro</option>
</select>

<div id="blocoEdicao" class="hidden">
  <label>Ano</label>
  <select id="ano"></select>

  <label>M√™s</label>
  <select id="mes"></select>

  <label>Despesa existente</label>
  <select id="despesaExistente"></select>
</div>

<label>Nome da despesa *</label>
<input id="nome_despesa">

<label>Tipo da despesa</label>
<input id="tipo_despesa">

<label>Categoria *</label>
<select id="categoria_despesa">
  <option value="">Selecione</option>
  <option>Alimenta√ß√£o</option>
  <option>Estruturas</option>
  <option>Manuten√ß√£o/Reparos</option>
  <option>Medicamentos</option>
  <option>Melhorias</option>
</select>

<label>Fornecedor</label>
<input id="fornecedor">

<label>Forma de pagamento</label>
<select id="forma_pagamento">
  <option value="">Selecione</option>
  <option>Dinheiro</option>
  <option>Pix</option>
  <option>Cart√£o</option>
  <option>Fiado</option>
</select>

<label>Status do pagamento</label>
<select id="status_pagamento">
  <option value="Pago">Pago</option>
  <option value="Pendente">Pendente</option>
</select>

<label>Quantidade</label>
<input id="quantidade" type="number" step="0.01">

<label>Valor unit√°rio</label>
<input id="valor_unitario" type="number" step="0.01">

<label>Valor total *</label>
<input id="valor_total" type="number" step="0.01" readonly>

<label>Data de vencimento *</label>
<input id="data_vencimento" type="date">

<label>Observa√ß√µes</label>
<textarea id="observacoes"></textarea>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button id="btnExcluir" class="excluir hidden" onclick="excluir()">üóëÔ∏è Excluir</button>

</div>

<script>
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    menu-adm.innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("cadastro_despesas")){
        a.classList.add("ativo");
      }
    });

    const s=document.createElement("script");
    s.src="../menu/menu-permissoes.js";
    document.body.appendChild(s);
  });

const db = firebase.firestore();
const auth = firebase.auth();

auth.onAuthStateChanged(user=>{
  if(!user) return;
  document.body.style.display="block";
  carregarDespesas();
});

let despesas = [];
let despesaAtual = null;

/* TOTAL AUTOM√ÅTICO */
quantidade.oninput = calcularTotal;
valor_unitario.oninput = calcularTotal;

function calcularTotal(){
  valor_total.value =
    (Number(quantidade.value||0)*Number(valor_unitario.value||0)).toFixed(2);
}

/* A√á√ÉO */
acao.onchange = ()=>{
  blocoEdicao.classList.toggle("hidden", acao.value !== "editar");
  btnExcluir.classList.add("hidden");
  limpar();
};

async function carregarDespesas(){
  const snap = await db.collection("despesas").get();
  despesas = snap.docs.map(d=>({id:d.id,...d.data()}));

  const anos=[...new Set(despesas.map(d=>d.ano))].filter(Boolean).sort();
  ano.innerHTML='<option value="">Selecione</option>';
  anos.forEach(a=>ano.innerHTML+=`<option>${a}</option>`);
}

ano.onchange = ()=>{
  mes.innerHTML='<option value="">Selecione</option>';
  despesaExistente.innerHTML='<option value="">Selecione</option>';

  despesas.filter(d=>d.ano===ano.value)
    .map(d=>d.mes)
    .filter((v,i,a)=>a.indexOf(v)===i)
    .sort()
    .forEach(m=>mes.innerHTML+=`<option>${m}</option>`);
};

mes.onchange = ()=>{
  despesaExistente.innerHTML='<option value="">Selecione</option>';
  despesas.filter(d=>d.ano===ano.value && d.mes===mes.value)
    .forEach(d=>{
      despesaExistente.innerHTML+=`<option value="${d.id}">${d.nome_despesa}</option>`;
    });
};

despesaExistente.onchange = ()=>{
  despesaAtual = despesas.find(d=>d.id===despesaExistente.value);
  if(!despesaAtual) return;

  Object.keys(despesaAtual).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value = despesaAtual[k];
  });

  btnExcluir.classList.remove("hidden");
};

async function salvar(){
  if(!nome_despesa.value.trim() || !categoria_despesa.value ||
     !valor_total.value || !data_vencimento.value){
    alert("Preencha os campos obrigat√≥rios.");
    return;
  }

  const hoje = new Date();

  const dados = {
    nome_despesa: nome_despesa.value.trim(),
    tipo_despesa: tipo_despesa.value.trim(),
    categoria_despesa,
    fornecedor: fornecedor.value.trim(),
    forma_pagamento,
    status_pagamento,
    quantidade: Number(quantidade.value||0),
    valor_unitario: Number(valor_unitario.value||0),
    valor_total: Number(valor_total.value||0),
    data_vencimento,
    observacoes: observacoes.value.trim(),
    ano: String(ano.value||hoje.getFullYear()),
    mes: String(mes.value||hoje.getMonth()+1),
    dia: String(hoje.getDate())
  };

  Object.keys(dados).forEach(k=>{
    if(dados[k]==="" || dados[k]===undefined) delete dados[k];
  });

  if(despesaAtual){
    await db.collection("despesas").doc(despesaAtual.id).update(dados);
    alert("Despesa atualizada com sucesso.");
  }else{
    await db.collection("despesas").add(dados);
    alert("Despesa cadastrada com sucesso.");
  }

  location.reload();
}

async function excluir(){
  if(!despesaAtual) return;
  if(confirm("Excluir esta despesa?")){
    await db.collection("despesas").doc(despesaAtual.id).delete();
    alert("Despesa exclu√≠da com sucesso.");
    location.reload();
  }
}

function limpar(){
  document.querySelectorAll("input,select,textarea").forEach(e=>{
    if(!["acao","ano","mes","despesaExistente"].includes(e.id)) e.value="";
  });
  despesaAtual=null;
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>