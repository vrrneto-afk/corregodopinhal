<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Farm√°cia ‚Äì ADM</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain:"sitio-corrego-do-pinhal.firebaseapp.com",
  projectId:"sitio-corrego-do-pinhal"
});
</script>

<!-- IDENTIFICA√á√ÉO DA P√ÅGINA -->
<script>
window.PERMISSAO_PAGINA = {
  area:"adm",
  chave:"cadastro_farmacia"
};
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#b03a2e;
  --logo:#D0B485;
}

*{
  box-sizing:border-box;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

body{
  margin:0;
  background:var(--bege);
  color:#333;
  display:none;
}

header{
  background:var(--logo);
  padding:14px;
  text-align:center;
  font-weight:800;
  font-size:17px;
}

.container{
  max-width:720px;
  margin:16px auto;
  padding:16px;
  background:#fff;
  border-radius:12px;
}

label{
  font-weight:600;
  margin-top:10px;
  display:block;
  font-size:14px;
}

input,select{
  width:100%;
  padding:10px 12px;
  margin-top:4px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  margin-top:14px;
  border:none;
  font-size:15px;
  cursor:pointer;
  border-radius:10px;
}

.salvar{background:var(--verde);color:#fff}
.excluir{background:var(--vermelho);color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<header>üíä Cadastro de Farm√°cia</header>

<div id="menu-adm"></div>

<div class="container">

<label>A√ß√£o</label>
<select id="acao">
  <option value="novo">‚ûï Novo registro</option>
  <option value="editar">‚úèÔ∏è Editar registro</option>
</select>

<div id="blocoEditar" class="hidden">
  <label>Medicamento cadastrado</label>
  <select id="existente"></select>
</div>

<label>Nome</label>
<input id="nome">

<label>Fun√ß√£o</label>
<input id="funcao">

<label>Status</label>
<select id="status">
  <option>Ativo</option>
  <option>Inativo</option>
</select>

<label>Quantidade em estoque</label>
<input id="quantidade" type="number">

<label>Data de compra</label>
<input id="data_compra" type="date">

<label>Validade</label>
<input id="validade" type="date">

<label>Tipo de dosagem</label>
<select id="dosagem_tipo">
  <option value="unica">Dose √∫nica</option>
  <option value="peso">Por peso</option>
</select>

<input id="dosagem_valor" placeholder="Valor da dose">

<select id="dosagem_unidade">
  <option>ml</option>
  <option>l</option>
  <option>gr</option>
  <option>mg</option>
</select>

<select id="peso_base" class="hidden">
  <option value="1">1kg</option>
  <option value="5">5kg</option>
  <option value="10">10kg</option>
  <option value="20">20kg</option>
  <option value="50">50kg</option>
  <option value="100">100kg</option>
</select>

<label>Via de aplica√ß√£o</label>
<select id="via">
  <option>Intramuscular</option>
  <option>Subcut√¢nea</option>
  <option>Oral</option>
  <option>Intravenosa</option>
</select>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button class="excluir hidden" id="btnExcluir" onclick="excluir()">üóëÔ∏è Excluir</button>

</div>

<script>
/* MENU ADM ‚Äì PADR√ÉO DEFINITIVO */
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("cadastro_farmacia")){
        a.classList.add("ativo");
      }
    });

    const s=document.createElement("script");
    s.src="../menu/menu-permissoes.js";
    document.body.appendChild(s);
  });

const db = firebase.firestore();
const auth = firebase.auth();

auth.onAuthStateChanged(user=>{
  if(!user) return;
  document.body.style.display="block";
  carregar();
});

/* ELEMENTOS */
const acao=document.getElementById("acao");
const blocoEditar=document.getElementById("blocoEditar");
const existente=document.getElementById("existente");
const btnExcluir=document.getElementById("btnExcluir");

const dosagem_tipo=document.getElementById("dosagem_tipo");
const peso_base=document.getElementById("peso_base");

const nome=document.getElementById("nome");
const funcao=document.getElementById("funcao");
const status=document.getElementById("status");
const quantidade=document.getElementById("quantidade");
const data_compra=document.getElementById("data_compra");
const validade=document.getElementById("validade");
const dosagem_valor=document.getElementById("dosagem_valor");
const dosagem_unidade=document.getElementById("dosagem_unidade");
const via=document.getElementById("via");

let medicamentos=[], atual=null;

/* DOSAGEM */
dosagem_tipo.onchange=()=>{
  peso_base.classList.toggle("hidden",dosagem_tipo.value!=="peso");
};

async function carregar(){
  const snap=await db.collection("farmacia").get();
  medicamentos=snap.docs.map(d=>({id:d.id,...d.data()}))
    .sort((a,b)=>(a.nome||"").localeCompare(b.nome||"","pt-BR"));

  existente.innerHTML='<option value="">Selecione</option>';
  medicamentos.forEach(m=>{
    existente.innerHTML+=`<option value="${m.id}">${m.nome}</option>`;
  });
}

acao.onchange=()=>{
  const editar=acao.value==="editar";
  blocoEditar.classList.toggle("hidden",!editar);
  btnExcluir.classList.toggle("hidden",!editar);
  atual=null;
  existente.value="";
};

existente.onchange=()=>{
  atual=medicamentos.find(m=>m.id===existente.value);
  if(!atual) return;

  nome.value=atual.nome||"";
  funcao.value=atual.funcao||"";
  status.value=atual.status||"Ativo";
  quantidade.value=atual.quantidade||0;
  data_compra.value=atual.data_compra||"";
  validade.value=atual.validade||"";
  dosagem_tipo.value=atual.dosagem_tipo||"unica";
  dosagem_valor.value=atual.dosagem_valor||"";
  dosagem_unidade.value=atual.dosagem_unidade||"ml";
  peso_base.value=atual.peso_base||"1";
  via.value=atual.via||"Intramuscular";

  peso_base.classList.toggle("hidden",dosagem_tipo.value!=="peso");
};

async function salvar(){
  const dados={
    nome:nome.value.trim(),
    funcao:funcao.value.trim(),
    status:status.value,
    quantidade:Number(quantidade.value||0),
    data_compra:data_compra.value,
    validade:validade.value,
    dosagem_tipo:dosagem_tipo.value,
    dosagem_valor:dosagem_valor.value,
    dosagem_unidade:dosagem_unidade.value,
    peso_base:dosagem_tipo.value==="peso"?peso_base.value:"",
    via:via.value,
    origem_registro:"manual"
  };

  if(atual){
    await db.collection("farmacia").doc(atual.id).update(dados);
  }else{
    dados.criado_em=firebase.firestore.FieldValue.serverTimestamp();
    dados.criado_por=auth.currentUser?.email||"";
    await db.collection("farmacia").add(dados);
  }

  alert("Medicamento salvo com sucesso.");
  location.reload();
}

async function excluir(){
  if(!atual) return;
  if(confirm(`Excluir o medicamento "${atual.nome}"?`)){
    await db.collection("farmacia").doc(atual.id).delete();
    alert("Medicamento exclu√≠do.");
    location.reload();
  }
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>