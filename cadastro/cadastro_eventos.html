<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Eventos ‚Äì ADM</title>

<!-- MANIFEST -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL (MESMO DO APP) -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal"
});
</script>

<!-- IDENTIFICA√á√ÉO DA P√ÅGINA (PADR√ÉO GLOBAL) -->
<script>
window.PERMISSAO_PAGINA = {
  area: "adm",
  chave: "cadastro_eventos"
};
</script>

<!-- AUTH GUARD GLOBAL -->
<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --verde:#2f6b2f;
  --vermelho:#b03a2e;
  --logo:#D0B485;
}

*{
  box-sizing:border-box;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

body{
  margin:0;
  background:var(--bege);
  color:#333;
}

header{
  background:var(--logo);
  padding:14px;
  text-align:center;
  font-weight:800;
  font-size:17px;
}

.container{
  max-width:720px;
  margin:16px auto;
  padding:16px;
  background:#fff;
  border-radius:12px;
}

label{
  font-weight:600;
  margin-top:10px;
  display:block;
  font-size:14px;
}

input,select,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:4px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

textarea{min-height:70px}

button{
  width:100%;
  padding:12px;
  margin-top:14px;
  border:none;
  font-size:15px;
  cursor:pointer;
  border-radius:10px;
}

.salvar{background:var(--verde);color:#fff}
.excluir{background:var(--vermelho);color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<header>üìÜ Cadastro de Eventos</header>

<div id="menu-adm"></div>

<div class="container">

<label>A√ß√£o</label>
<select id="acao">
  <option value="novo">‚ûï Novo registro</option>
  <option value="editar">‚úèÔ∏è Editar registro</option>
</select>

<div id="blocoEditar" class="hidden">
  <label>Evento cadastrado</label>
  <select id="eventoExistente"></select>
</div>

<label>Animal (ativo)</label>
<select id="animal"></select>

<label>Tipo de evento</label>
<select id="tipo_evento">
  <option value="">Selecione</option>
  <option value="cobertura">Cobertura</option>
  <option value="parto">Parto</option>
  <option value="venda">Venda</option>
  <option value="falecimento">Falecimento</option>
</select>

<div id="blocoCobertura" class="hidden">
  <label>Boi (ativo)</label>
  <select id="boi"></select>
</div>

<label>Data do evento</label>
<input type="date" id="data_evento">

<label>Status do evento</label>
<select id="status_evento">
  <option>Confirmado</option>
  <option>Pendente</option>
</select>

<label>Observa√ß√µes</label>
<textarea id="observacoes"></textarea>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button class="excluir hidden" id="btnExcluir" onclick="excluir()">üóëÔ∏è Excluir</button>

</div>

<script>
/* MENU ADM ‚Äì PADR√ÉO GLOBAL */
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu-adm").innerHTML = html;

    const atualPag = location.pathname.split("/").pop();
    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes(atualPag)){
        a.classList.add("ativo");
      }
    });
  });

const db = firebase.firestore();
const auth = firebase.auth();

/* ELEMENTOS */
const acao = document.getElementById("acao");
const blocoEditar = document.getElementById("blocoEditar");
const eventoExistente = document.getElementById("eventoExistente");
const animal = document.getElementById("animal");
const tipo_evento = document.getElementById("tipo_evento");
const boi = document.getElementById("boi");
const blocoCobertura = document.getElementById("blocoCobertura");
const data_evento = document.getElementById("data_evento");
const status_evento = document.getElementById("status_evento");
const observacoes = document.getElementById("observacoes");
const btnExcluir = document.getElementById("btnExcluir");

let ANIMAIS = [];
let EVENTOS = [];
let atual = null;

/* LOAD INICIAL */
async function carregar(){
  /* ANIMAIS ATIVOS */
  const snapAnimais = await db.collection("animais")
    .where("status","==","Ativo")
    .get();

  ANIMAIS = snapAnimais.docs
    .map(d=>({id:d.id,...d.data()}))
    .sort((a,b)=>(a.nome||"").localeCompare(b.nome||"","pt-BR"));

  animal.innerHTML = '<option value="">Selecione</option>';
  boi.innerHTML = '<option value="">Selecione</option>';

  ANIMAIS.forEach(a=>{
    animal.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
    if(a.sexo==="M"){
      boi.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
    }
  });

  /* EVENTOS */
  const snapEventos = await db.collection("eventos").get();
  EVENTOS = snapEventos.docs.map(d=>({id:d.id,...d.data()}));

  eventoExistente.innerHTML = '<option value="">Selecione</option>';
  EVENTOS.forEach(e=>{
    const nome =
      e.nome_animal ||
      e.animal_nome ||
      e.nome ||
      "Animal n√£o informado";

    eventoExistente.innerHTML +=
      `<option value="${e.id}">${nome} ‚Äì ${e.tipo_evento}</option>`;
  });
}

/* A√á√ÉO */
acao.onchange = ()=>{
  const editar = acao.value === "editar";
  blocoEditar.classList.toggle("hidden", !editar);
  btnExcluir.classList.toggle("hidden", !editar);
  atual = null;
};

/* EDITAR EVENTO */
eventoExistente.onchange = ()=>{
  atual = EVENTOS.find(e=>e.id===eventoExistente.value);
  if(!atual) return;

  animal.value = atual.id_animal || "";
  tipo_evento.value = atual.tipo_evento || "";
  data_evento.value = atual.data_evento || "";
  status_evento.value = atual.status_evento || "Confirmado";
  observacoes.value = atual.observacoes || "";
  boi.value = atual.id_relacionado || "";

  blocoCobertura.classList.toggle("hidden", tipo_evento.value!=="cobertura");
};

/* TIPO EVENTO */
tipo_evento.onchange = ()=>{
  blocoCobertura.classList.toggle("hidden", tipo_evento.value!=="cobertura");
};

/* SALVAR */
async function salvar(){
  if(!animal.value || !tipo_evento.value || !data_evento.value){
    alert("Preencha animal, tipo e data.");
    return;
  }

  const a = ANIMAIS.find(x=>x.id===animal.value);

  let dados = {
    id_animal: animal.value,
    nome_animal: a?.nome || "",
    especie: a?.especie || "",
    tipo_evento: tipo_evento.value,
    data_evento: data_evento.value,
    id_relacionado: tipo_evento.value==="cobertura" ? boi.value : "",
    status_evento: status_evento.value,
    observacoes: observacoes.value.trim(),
    origem_registro: "manual"
  };

  if(!atual){
    dados.criado_em = firebase.firestore.FieldValue.serverTimestamp();
    dados.criado_por = auth.currentUser?.email || "";
  }

  /* COBERTURA ‚Üí GERA PARTO */
  if(tipo_evento.value==="cobertura"){
    const cfgSnap = await db.collection("config").doc("especies").get();
    const cfg = cfgSnap.data()?.[a.especie] || {};
    const meses = Number(cfg.gestacao_meses || 0);

    if(meses>0){
      const d = new Date(data_evento.value+"T00:00:00");
      d.setMonth(d.getMonth()+meses);
      dados.gestacao_meses = meses;
      dados.data_prevista_parto = d.toISOString().slice(0,10);
    }
  }

  /* VENDA / FALECIMENTO */
  if(["venda","falecimento"].includes(tipo_evento.value)){
    await db.collection("animais").doc(animal.value).update({
      status: tipo_evento.value==="venda" ? "Vendido" : "Falecido"
    });
  }

  if(atual){
    await db.collection("eventos").doc(atual.id).update(dados);
  }else{
    await db.collection("eventos").add(dados);
  }

  alert("Evento salvo com sucesso.");
  location.reload();
}

/* EXCLUIR */
async function excluir(){
  if(!atual) return;
  if(confirm("Confirma a exclus√£o deste evento?")){
    await db.collection("eventos").doc(atual.id).delete();
    alert("Evento exclu√≠do.");
    location.reload();
  }
}

carregar();
</script>

<!-- LOGOUT GLOBAL -->
<script src="../login/logout.js"></script>

</body>
</html>