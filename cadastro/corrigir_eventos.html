<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Correção de Eventos</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal"
});
</script>
</head>

<body>
<h3>Corrigindo eventos...</h3>

<script>
(async ()=>{
  const db = firebase.firestore();

  const snapEventos = await db.collection("eventos").get();
  const snapAnimais = await db.collection("animais").get();

  const animais = {};
  snapAnimais.docs.forEach(d=>{
    animais[d.id] = d.data();
  });

  let corrigidos = 0;

  for(const doc of snapEventos.docs){
    const e = doc.data();
    if(e.id_animal && !e.nome_animal){
      const a = animais[e.id_animal];
      if(a){
        await db.collection("eventos").doc(doc.id).update({
          nome_animal: a.nome || "",
          especie: a.especie || ""
        });
        corrigidos++;
      }
    }
  }

  alert("Correção concluída. Eventos corrigidos: " + corrigidos);
})();
</script>
</body>
</html>