<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Corre√ß√£o de Eventos</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
  authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
  projectId: "sitio-corrego-do-pinhal"
});
</script>

<style>
body{
  font-family: system-ui, Arial;
  background:#f6efe7;
  padding:20px;
}
</style>
</head>

<body>

<h3>üîß Corrigindo eventos‚Ä¶</h3>
<p id="status">Aguardando autentica√ß√£o‚Ä¶</p>

<script>
const auth = firebase.auth();
const db   = firebase.firestore();

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    document.getElementById("status").innerText =
      "‚ùå Usu√°rio n√£o autenticado. Fa√ßa login antes.";
    return;
  }

  document.getElementById("status").innerText =
    "üîç Buscando eventos e animais‚Ä¶";

  const snapEventos = await db.collection("eventos").get();
  const snapAnimais = await db.collection("animais").get();

  const animais = {};
  snapAnimais.docs.forEach(d=>{
    animais[d.id] = d.data();
  });

  let corrigidos = 0;

  for(const doc of snapEventos.docs){
    const e = doc.data();

    if(e.id_animal && !e.nome_animal){
      const a = animais[e.id_animal];
      if(a){
        await db.collection("eventos").doc(doc.id).update({
          nome_animal: a.nome || "",
          especie: a.especie || ""
        });
        corrigidos++;
      }
    }
  }

  document.getElementById("status").innerText =
    `‚úÖ Corre√ß√£o conclu√≠da. Eventos corrigidos: ${corrigidos}`;

  alert(`Corre√ß√£o conclu√≠da. Eventos corrigidos: ${corrigidos}`);
});
</script>

</body>
</html>