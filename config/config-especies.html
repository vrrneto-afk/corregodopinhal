<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Esp√©cies</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-especies"
};
</script>

<script src="../login/auth-guard.js"></script>

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:12px;
  font-weight:600;
}
.check-row input{margin:0;}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>

<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Esp√©cies</h2>

<div class="cards-grid" id="lista-especies"></div>

<div id="editor" class="hidden">
<fieldset>

<label>Nome da esp√©cie</label>
<input type="text" id="esp_id">

<label>√çcone da esp√©cie (emoji)</label>
<input type="text" id="esp_icone" placeholder="Ex: üêÑ üêì üê∂">

<div class="check-row">
  <input type="checkbox" id="esp_ativo" checked>
  <label>Esp√©cie ativa</label>
</div>

<div class="check-row">
  <input type="checkbox" id="possui_gestacao">
  <label>Possui gesta√ß√£o</label>
</div>

<div class="check-row">
  <input type="checkbox" id="possui_incubacao">
  <label>Possui incuba√ß√£o</label>
</div>

<div id="campo_gestacao" class="hidden">
  <label>Gesta√ß√£o (meses)</label>
  <input type="number" id="gestacao_meses" min="0">
</div>

<div id="campo_incubacao" class="hidden">
  <label>Incuba√ß√£o (dias)</label>
  <input type="number" id="incubacao_dias" min="0">
</div>

</fieldset>

<button class="salvar" onclick="salvarEspecie()">üíæ Salvar</button>

<button class="voltar" id="btnExcluir"
  onclick="excluirEspecie()"
  style="background:#b03a2e;color:#fff">
  üóë Excluir esp√©cie
</button>

<button class="voltar" onclick="cancelarEdicao()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>

<script>
fetch("../menu/menu-adm.html")
.then(r=>r.text())
.then(html=>{
  document.getElementById("menu-adm").innerHTML = html;

  const s=document.createElement("script");
  s.src="../menu/menu-permissoes.js";
  s.onload=()=>{
    document.body.style.display="block";
    carregar();
  };
  document.body.appendChild(s);
});
</script>

<script>
const db = firebase.firestore();

let especies = [];
let indiceEditando = null;

async function carregar(){
  const snap = await db.collection("config").doc("especies").get();
  especies = snap.exists ? snap.data().lista || [] : [];
  renderizarCards();
}

function renderizarCards(){
  lista_especies.innerHTML="";
  especies.forEach((e,i)=>{
    const btn=document.createElement("button");
    btn.className="config-card";
    btn.onclick=()=>editarEspecie(i);
    if(e.ativo===false) btn.style.opacity="0.5";

    let desc="";
    if(e.possui_gestacao) desc=`Gesta√ß√£o: ${e.gestacao_meses} meses`;
    if(e.possui_incubacao) desc=`Incuba√ß√£o: ${e.incubacao_dias} dias`;

    btn.innerHTML=`<strong>${e.icone||"üêæ"} ${e.id}</strong><span>${desc}</span>`;
    lista_especies.appendChild(btn);
  });

  const novo=document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Nova esp√©cie";
  novo.onclick=novaEspecie;
  lista_especies.appendChild(novo);
}

function novaEspecie(){
  indiceEditando=null;
  limparFormulario();
  btnExcluir.style.display="none";
  editor.classList.remove("hidden");
}

function editarEspecie(i){
  indiceEditando=i;
  const e=especies[i];
  esp_id.value=e.id||"";
  esp_icone.value=e.icone||"";
  esp_ativo.checked=e.ativo!==false;
  possui_gestacao.checked=!!e.possui_gestacao;
  possui_incubacao.checked=!!e.possui_incubacao;
  gestacao_meses.value=e.gestacao_meses||"";
  incubacao_dias.value=e.incubacao_dias||"";
  ajustarCampos();
  btnExcluir.style.display="block";
  editor.classList.remove("hidden");
}

function ajustarCampos(){
  campo_gestacao.classList.toggle("hidden",!possui_gestacao.checked);
  campo_incubacao.classList.toggle("hidden",!possui_incubacao.checked);
}

async function salvarEspecie(){
  const obj={
    id:esp_id.value.trim(),
    icone:esp_icone.value.trim(),
    ativo:esp_ativo.checked
  };

  if(!obj.id){
    alert("Informe o nome da esp√©cie.");
    return;
  }

  if(possui_gestacao.checked){
    obj.possui_gestacao=true;
    obj.gestacao_meses=Number(gestacao_meses.value||0);
  }
  if(possui_incubacao.checked){
    obj.possui_incubacao=true;
    obj.incubacao_dias=Number(incubacao_dias.value||0);
  }

  if(indiceEditando===null) especies.push(obj);
  else especies[indiceEditando]=obj;

  await db.collection("config").doc("especies").set({lista:especies},{merge:true});

  alert("Configura√ß√£o salva com sucesso.");
  location.reload();
}

async function excluirEspecie(){
  if(!confirm("Excluir definitivamente esta esp√©cie?")) return;
  especies.splice(indiceEditando,1);
  await db.collection("config").doc("especies").set({lista:especies},{merge:true});
  alert("Esp√©cie exclu√≠da com sucesso.");
  location.reload();
}

function cancelarEdicao(){
  editor.classList.add("hidden");
}

function limparFormulario(){
  esp_id.value="";
  esp_icone.value="";
  esp_ativo.checked=true;
  possui_gestacao.checked=false;
  possui_incubacao.checked=false;
  gestacao_meses.value="";
  incubacao_dias.value="";
  ajustarCampos();
}
</script>

<script src="../login/logout.js"></script>
</body>
</html>
