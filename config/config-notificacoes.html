<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o de Notifica√ß√µes</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">
<link rel="stylesheet" href="../menu/menu.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"config", chave:"config-notificacoes" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --cinza:#666;
  --borda:#e5e5e5;
}

*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);display:none;color:#333}

header{background:#D0B485;padding:16px;text-align:center}
header h2{margin:0;color:var(--marrom)}

.container{max-width:900px;margin:20px auto;padding:0 15px}

.tabs{display:flex;gap:8px;margin-bottom:14px}
.tab{
  flex:1;
  text-align:center;
  padding:10px;
  background:#fff;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.tab.ativo{background:var(--marrom);color:#fff}

.card{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  border:1px solid var(--borda);
}

.card h3{margin:0 0 10px;color:var(--marrom)}

.linha{margin-bottom:10px}

input, textarea, select{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid var(--marrom);
  background:#fff;
  color:var(--marrom);
  font-weight:700;
  cursor:pointer;
}

button.primario{background:var(--marrom);color:#fff}

.horario-item, .tipo-item{
  border:1px dashed var(--borda);
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  cursor:pointer;
}

.checkbox-linha{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:6px;
  font-weight:600;
}
.checkbox-linha input{
  width:auto;
  margin:0;
}

.container{
  max-width:900px;
  margin:140px auto 20px; /* header + menu */
  padding:0 15px;
}
</style>
</head>

<body>

<header>
  <h2>üîî Configura√ß√£o de Notifica√ß√µes</h2>
</header>

<div id="menu"></div>

<div class="container">

  <div class="tabs">
    <div class="tab ativo" data-tab="horarios">‚è∞ Hor√°rios</div>
    <div class="tab" data-tab="tipos">üì¶ Tipos</div>
    <div class="tab" data-tab="automaticas">‚öôÔ∏è Autom√°ticas</div>
    <div class="tab" data-tab="manuais">‚úçÔ∏è Manuais</div>
  </div>

  <div id="tab-horarios">
    <div class="card">
      <h3>Hor√°rios de envio</h3>
      <div id="listaHorarios"></div>
      <button onclick="novoHorario()">‚ûï Adicionar hor√°rio</button>
    </div>
  </div>

  <div id="tab-tipos" style="display:none">
    <div class="card">
      <h3>Tipos de notifica√ß√£o</h3>
      <div id="listaTipos"></div>
      <button onclick="novoTipo()">‚ûï Adicionar tipo</button>
    </div>
  </div>

  <div id="tab-automaticas" style="display:none">
    <div class="card">
      <h3>‚öôÔ∏è Notifica√ß√µes autom√°ticas</h3>
      <label class="checkbox-linha">
        <input type="checkbox" id="autoSistemaAtivo">
        Sistema de notifica√ß√µes autom√°ticas ativo
      </label>
    </div>

    <div class="card">
      <h3>Configura√ß√µes</h3>
      <div id="listaAutomaticas"></div>
      <button onclick="novaAutomatica()">‚ûï Adicionar notifica√ß√£o autom√°tica</button>
    </div>
  </div>

  <div id="tab-manuais" style="display:none">
    <div class="card">
      <h3>Nova notifica√ß√£o manual</h3>

      <div class="linha">
        <label>T√≠tulo</label>
        <input id="manTitulo">
      </div>

      <div class="linha">
        <label>Mensagem</label>
        <textarea id="manMsg"></textarea>
      </div>

      <div class="linha">
        <label>Enviar em</label>
        <input type="date" id="manData">
        <input type="time" id="manHora">
      </div>

      <button class="primario" onclick="enviarManual()">üì¢ Enviar</button>
    </div>
  </div>

</div>

<!-- MODAL AUTOM√ÅTICA -->
<div id="modalAutomatica" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#fff;width:95%;max-width:520px;border-radius:14px;padding:16px">
    <h3 style="color:#7b3f2a">‚öôÔ∏è Notifica√ß√£o autom√°tica</h3>

    <label class="checkbox-linha">
      <input type="checkbox" id="aAtivo"> Ativa
    </label>

    <div class="linha">
      <label>Tipo</label>
      <select id="aTipo"></select>
    </div>

    <div class="linha">
      <label>T√≠tulo</label>
      <input id="aTitulo">
    </div>

    <div class="linha">
      <label>Mensagem</label>
      <textarea id="aMensagem"></textarea>
    </div>

    <div class="linha">
      <label>Grupos</label>
      <label class="checkbox-linha"><input type="checkbox" value="admin" class="aGrupo"> Admin</label>
      <label class="checkbox-linha"><input type="checkbox" value="gerente" class="aGrupo"> Gerente</label>
      <label class="checkbox-linha"><input type="checkbox" value="leitor" class="aGrupo"> Leitor</label>
    </div>

    <div class="linha">
      <label>Hor√°rios</label>
      <div id="aHorarios"></div>
    </div>

    <div class="linha">
      <label>M√°x. por dia</label>
      <input type="number" id="aMaxDia" value="1">
      <label class="checkbox-linha">
        <input type="checkbox" id="aEvitarRep"> Evitar repeti√ß√£o
      </label>
    </div>

    <div style="display:flex;gap:8px">
      <button class="primario" onclick="salvarAutomatica()">üíæ Salvar</button>
      <button onclick="fecharModalAutomatica()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const db = firebase.firestore();

let horarioEditandoId = null;
let tipoEditandoId = null;
let automaticaEditandoId = null;

/* ================= MENU ================= */
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {

    document.getElementById("menu").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a => {
      if (a.getAttribute("href")?.includes("config.html")) {
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => {
    document.body.style.display = "block";
    inicializarTabs();     // ‚úÖ AQUI
    carregarHorarios();
    carregarTipos();
    carregarAutomaticas();
  };

    document.body.appendChild(s);
  });
</script>

<script>

/* ================= TABS ================= */
function inicializarTabs() {
  document.querySelectorAll(".tab").forEach(t => {
    t.onclick = () => {

      document.querySelectorAll(".tab")
        .forEach(x => x.classList.remove("ativo"));

      t.classList.add("ativo");

      document.querySelectorAll("[id^=tab-]")
        .forEach(d => d.style.display = "none");

      document.getElementById("tab-" + t.dataset.tab)
        .style.display = "block";
    };
  });
}

/* ================= HOR√ÅRIOS ================= */
async function carregarHorarios() {
  const snap = await db
    .collection("config")
    .doc("notificacoes_horarios")
    .get();

  if (!snap.exists) return;

  const lista = snap.data().lista || [];
  listaHorarios.innerHTML = "";

  lista.forEach(h => {
    listaHorarios.innerHTML += `
      <div class="horario-item" onclick="editarHorario('${h.id}')">
        <strong>${h.nome}</strong><br>
        ‚è∞ ${h.hora} | ${h.ativo ? "üü¢ Ativo" : "üî¥ Inativo"}
      </div>
    `;
  });
}

function novoHorario() {
  horarioEditandoId = null;
  hNome.value = "";
  hHora.value = "";
  hAtivo.checked = true;
  modalHorario.style.display = "flex";
}

async function editarHorario(id) {
  const snap = await db
    .collection("config")
    .doc("notificacoes_horarios")
    .get();

  const h = snap.data().lista.find(x => x.id === id);
  if (!h) return;

  horarioEditandoId = id;
  hNome.value = h.nome;
  hHora.value = h.hora;
  hAtivo.checked = h.ativo;

  modalHorario.style.display = "flex";
}

async function salvarHorario() {
  const nome  = hNome.value.trim();
  const hora  = hHora.value;
  const ativo = hAtivo.checked;

  if (!nome || !hora) {
    return alert("Preencha nome e hora");
  }

  const ref  = db.collection("config").doc("notificacoes_horarios");
  const snap = await ref.get();

  let lista = snap.exists ? snap.data().lista || [] : [];

  if (horarioEditandoId) {
    lista = lista.map(h =>
      h.id === horarioEditandoId
        ? { ...h, nome, hora, ativo }
        : h
    );
  } else {
    lista.push({
      id: nome.toLowerCase().replace(/\s+/g, "-"),
      nome,
      hora,
      ativo
    });
  }

  await ref.set({ ativo: true, lista }, { merge: true });

  modalHorario.style.display = "none";
  carregarHorarios();
}

function fecharModalHorario() {
  modalHorario.style.display = "none";
}

/* ================= TIPOS ================= */
async function carregarTipos() {
  const snap = await db
    .collection("config")
    .doc("notificacoes_tipos")
    .get();

  if (!snap.exists) return;

  const lista = snap.data().lista || [];
  listaTipos.innerHTML = "";

  lista.forEach(t => {
    listaTipos.innerHTML += `
      <div class="tipo-item" onclick="editarTipo('${t.id}')">
        <strong>${t.nome}</strong><br>
        ${t.descricao || ""}<br>
        ${t.ativo ? "üü¢ Ativo" : "üî¥ Inativo"}
      </div>
    `;
  });
}

function novoTipo() {
  tipoEditandoId = null;
  tNome.value = "";
  tDesc.value = "";
  tAtivo.checked = true;
  modalTipo.style.display = "flex";
}

async function editarTipo(id) {
  const snap = await db
    .collection("config")
    .doc("notificacoes_tipos")
    .get();

  const t = snap.data().lista.find(x => x.id === id);
  if (!t) return;

  tipoEditandoId = id;
  tNome.value  = t.nome;
  tDesc.value  = t.descricao || "";
  tAtivo.checked = t.ativo;

  modalTipo.style.display = "flex";
}

async function salvarTipo() {
  const nome = tNome.value.trim();
  if (!nome) return alert("Nome obrigat√≥rio");

  const ref  = db.collection("config").doc("notificacoes_tipos");
  const snap = await ref.get();

  let lista = snap.exists ? snap.data().lista || [] : [];

  if (tipoEditandoId) {
    lista = lista.map(t =>
      t.id === tipoEditandoId
        ? {
            ...t,
            nome,
            descricao: tDesc.value,
            ativo: tAtivo.checked
          }
        : t
    );
  } else {
    lista.push({
      id: nome.toLowerCase().replace(/\s+/g, "-"),
      nome,
      descricao: tDesc.value,
      ativo: tAtivo.checked
    });
  }

  await ref.set({ ativo: true, lista }, { merge: true });

  modalTipo.style.display = "none";
  carregarTipos();
}

function fecharModalTipo() {
  modalTipo.style.display = "none";
}

/* ================= AUTOM√ÅTICAS ================= */
let automaticaEditandoId = null;

/* ===== CARREGAR AUTOM√ÅTICAS ===== */
async function carregarAutomaticas() {
  const snap = await db
    .collection("config")
    .doc("notificacoes_automaticas")
    .get();

  if (!snap.exists) return;

  const lista = snap.data().lista || [];
  const div   = document.getElementById("listaAutomaticas");

  div.innerHTML = "";

  lista.forEach(a => {
    div.innerHTML += `
      <div class="horario-item" onclick="editarAutomatica('${a.id}')">
        <strong>${a.titulo}</strong><br>
        Grupos: ${a.grupos.join(", ")}<br>
        Hor√°rios: ${a.horarios.join(", ")}<br>
        ${a.ativo ? "üü¢ Ativa" : "üî¥ Inativa"}
      </div>
    `;
  });
}

/* ===== NOVA ===== */
async function novaAutomatica() {
  automaticaEditandoId = null;

  aTitulo.value   = "";
  aMensagem.value = "";
  aAtivo.checked  = true;
  aMaxDia.value   = 1;
  aEvitarRep.checked = true;

  await carregarTipos();
  await carregarHorariosCheckbox();

  abrirModalAutomatica();
}

/* ===== SALVAR ===== */
async function salvarAutomatica() {
  const ref  = db.collection("config").doc("notificacoes_automaticas");
  const snap = await ref.get();

  let lista = snap.exists ? snap.data().lista || [] : [];

  const grupos = [...document.querySelectorAll(".aGrupo:checked")]
    .map(x => x.value);

  const horarios = [...document.querySelectorAll(".aHorario:checked")]
    .map(x => x.value);

  const obj = {
    id: automaticaEditandoId ||
        aTitulo.value.toLowerCase().replace(/\s+/g, "-"),

    tipo: aTipo.value,
    ativo: aAtivo.checked,
    grupos,
    horarios,
    titulo: aTitulo.value,
    mensagem: aMensagem.value,

    controle: {
      max_por_dia: Number(aMaxDia.value),
      evitar_repeticao: aEvitarRep.checked
    }
  };

  if (automaticaEditandoId) {
    lista = lista.map(x =>
      x.id === automaticaEditandoId ? obj : x
    );
  } else {
    lista.push(obj);
  }

  await ref.set({ ativo: true, lista }, { merge: true });

  fecharModalAutomatica();
  carregarAutomaticas();
}

function abrirModalAutomatica() {
  document.getElementById("modalAutomatica").style.display = "flex";
}

function fecharModalAutomatica() {
  document.getElementById("modalAutomatica").style.display = "none";
}

/* ===== FUN√á√ÉO QUE FALTAVA ===== */
async function carregarHorariosCheckbox(){
  const snap = await db.collection("config").doc("notificacoes_horarios").get();
  if(!snap.exists) return;

  const lista = snap.data().lista || [];
  aHorarios.innerHTML = "";

  lista.forEach(h=>{
    aHorarios.innerHTML += `
      <label class="checkbox-linha">
        <input type="checkbox" class="aHorario" value="${h.id}">
        ${h.nome} (${h.hora})
      </label>`;
  });
}

/* ===== FUN√á√ÉO QUE FALTAVA ===== */
async function editarAutomatica(id){
  const snap = await db.collection("config").doc("notificacoes_automaticas").get();
  if(!snap.exists) return;

  const a = snap.data().lista.find(x=>x.id===id);
  if(!a) return;

  automaticaEditandoId = id;

  aTitulo.value = a.titulo;
  aMensagem.value = a.mensagem;
  aAtivo.checked = a.ativo;
  aMaxDia.value = a.controle?.max_por_dia || 1;
  aEvitarRep.checked = a.controle?.evitar_repeticao !== false;

  await carregarHorariosCheckbox();

  document.querySelectorAll(".aGrupo").forEach(c=>{
    c.checked = a.grupos.includes(c.value);
  });

  document.querySelectorAll(".aHorario").forEach(c=>{
    c.checked = a.horarios.includes(c.value);
  });

  modalAutomatica.style.display = "flex";
}
</script>

<script src="../login/logout.js"></script>
</body>
</html>
