<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o de Notifica√ß√µes</title>

<!-- PWA -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"config", chave:"config-notificacoes" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
:root{
  --marrom:#7b3f2a;
  --bege:#f6efe7;
  --borda:#e5e5e5;
}

*{box-sizing:border-box;font-family:Inter,system-ui,Arial}
body{margin:0;background:var(--bege);color:#333}

/* HEADER */
header{background:#D0B485;padding:16px;text-align:center}
header h2{margin:0;color:var(--marrom)}

/* CONTAINER */
.container{max-width:900px;margin:20px auto;padding:0 14px}

/* TABS */
.tabs{display:flex;gap:10px;margin:14px 0}
.tab{
  flex:1;background:#fff;border-radius:14px;padding:10px 6px;
  text-align:center;cursor:pointer;font-weight:700;
  border:1px solid var(--borda)
}
.tab span{display:block;font-size:22px}
.tab small{display:block;margin-top:4px}
.tab.ativo{background:var(--marrom);color:#fff}

/* CARD */
.card{
  background:#fff;border-radius:16px;padding:14px;
  border:1px solid var(--borda);margin-bottom:14px
}
.card h3{margin:0 0 10px;color:var(--marrom)}

/* LISTAS */
.item{
  border:1px dashed var(--borda);
  border-radius:12px;padding:10px;margin-bottom:8px
}

/* BOT√ïES */
button{
  padding:8px 12px;border-radius:10px;
  border:1px solid var(--marrom);
  background:#fff;color:var(--marrom);
  font-weight:700;cursor:pointer
}
button.primario{background:var(--marrom);color:#fff}

/* FORM */
.linha{margin-bottom:10px}
input,textarea,select{
  width:100%;padding:8px;border-radius:8px;border:1px solid #ccc
}
.checkbox{display:flex;align-items:center;gap:8px}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;z-index:9999
}
.modal-box{
  background:#fff;width:95%;max-width:520px;
  border-radius:16px;padding:16px
}
.modal-footer{display:flex;gap:8px;margin-top:10px}
</style>
</head>

<body>

<header>
  <h2>üîî Configura√ß√£o de Notifica√ß√µes</h2>
</header>

<div id="menu"></div>

<div class="container">

<div class="tabs">
  <div class="tab ativo" data-tab="horarios"><span>‚è∞</span><small>Hor√°rios</small></div>
  <div class="tab" data-tab="tipos"><span>üì¶</span><small>Tipos</small></div>
  <div class="tab" data-tab="automaticas"><span>‚öôÔ∏è</span><small>Autom√°ticas</small></div>
  <div class="tab" data-tab="manuais"><span>‚úçÔ∏è</span><small>Manuais</small></div>
</div>

<!-- HOR√ÅRIOS -->
<div id="tab-horarios">
  <div class="card">
    <h3>Hor√°rios</h3>
    <div id="listaHorarios"></div>
    <button onclick="abrirHorario()">‚ûï Novo hor√°rio</button>
  </div>
</div>

<!-- TIPOS -->
<div id="tab-tipos" style="display:none">
  <div class="card">
    <h3>Tipos</h3>
    <div id="listaTipos"></div>
    <button onclick="abrirTipo()">‚ûï Novo tipo</button>
  </div>
</div>

<!-- AUTOM√ÅTICAS -->
<div id="tab-automaticas" style="display:none">
  <div class="card">
    <h3>Autom√°ticas</h3>
    <div id="listaAutomaticas"></div>
    <button onclick="abrirAutomatica()">‚ûï Nova autom√°tica</button>
  </div>
</div>

<!-- MANUAIS -->
<div id="tab-manuais" style="display:none">
  <div class="card">
    <h3>Manual</h3>
    <div class="linha"><input id="mTitulo" placeholder="T√≠tulo"></div>
    <div class="linha"><textarea id="mMsg" placeholder="Mensagem"></textarea></div>
    <div class="linha">
      <input type="date" id="mData">
      <input type="time" id="mHora">
    </div>
    <button class="primario" onclick="salvarManual()">üíæ Salvar</button>
  </div>
</div>

</div>

<!-- MODAL HOR√ÅRIO -->
<div class="modal" id="modalHorario">
  <div class="modal-box">
    <h3>Hor√°rio</h3>
    <input id="hNome" placeholder="Nome">
    <input id="hHora" type="time">
    <label class="checkbox"><input type="checkbox" id="hAtivo"> Ativo</label>
    <div class="modal-footer">
      <button class="primario" onclick="salvarHorario()">Salvar</button>
      <button onclick="fechar('modalHorario')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL TIPO -->
<div class="modal" id="modalTipo">
  <div class="modal-box">
    <h3>Tipo</h3>
    <input id="tNome" placeholder="Nome">
    <textarea id="tDesc" placeholder="Descri√ß√£o"></textarea>
    <label class="checkbox"><input type="checkbox" id="tAtivo"> Ativo</label>
    <div class="modal-footer">
      <button class="primario" onclick="salvarTipo()">Salvar</button>
      <button onclick="fechar('modalTipo')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL AUTOM√ÅTICA -->
<div class="modal" id="modalAutomatica">
  <div class="modal-box">
    <h3>Autom√°tica</h3>
    <label class="checkbox"><input type="checkbox" id="aAtivo"> Ativa</label>
    <select id="aTipo"></select>
    <input id="aTitulo" placeholder="T√≠tulo">
    <textarea id="aMsg" placeholder="Mensagem"></textarea>
    <label class="checkbox"><input type="checkbox" class="aGrupo" value="admin"> Admin</label>
    <label class="checkbox"><input type="checkbox" class="aGrupo" value="gerente"> Gerente</label>
    <label class="checkbox"><input type="checkbox" class="aGrupo" value="leitor"> Leitor</label>
    <div id="aHorarios"></div>
    <div class="modal-footer">
      <button class="primario" onclick="salvarAutomatica()">Salvar</button>
      <button onclick="fechar('modalAutomatica')">Cancelar</button>
    </div>
  </div>
</div>

<script>
const db = firebase.firestore();
let editH=null,editT=null,editA=null;

/* MENU */
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("config.html")){
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    document.body.appendChild(s);

    inicializarTela();
  });

/* TABS */
document.addEventListener("click",e=>{
  const t=e.target.closest(".tab");if(!t)return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("ativo"));
  t.classList.add("ativo");
  document.querySelectorAll("[id^=tab-]").forEach(d=>d.style.display="none");
  document.getElementById("tab-"+t.dataset.tab).style.display="block";
});

function fechar(id){document.getElementById(id).style.display="none"}

/* INIT */
function init(){
  carregarHorarios();
  carregarTipos();
  carregarAutomaticas();
}

/* HOR√ÅRIOS */
async function carregarHorarios(){
  const d=await db.doc("config/notificacoes_horarios").get();
  const l=d.exists?d.data().lista||[]:[];
  listaHorarios.innerHTML="";
  l.forEach(h=>{
    listaHorarios.innerHTML+=`
      <div class="item"><b>${h.nome}</b> ${h.hora}
      <button onclick="editarHorario('${h.id}')">‚úèÔ∏è</button>
      <button onclick="excluirHorario('${h.id}')">üóëÔ∏è</button></div>`;
  });
}
function abrirHorario(){editH=null;hNome.value="";hHora.value="";hAtivo.checked=true;modalHorario.style.display="flex"}
async function editarHorario(id){
  const d=await db.doc("config/notificacoes_horarios").get();
  const h=d.data().lista.find(x=>x.id===id);
  editH=id;hNome.value=h.nome;hHora.value=h.hora;hAtivo.checked=h.ativo;
  modalHorario.style.display="flex";
}
async function salvarHorario(){
  const ref=db.doc("config/notificacoes_horarios");
  const d=await ref.get();let l=d.exists?d.data().lista||[]:[];
  const obj={id:editH||crypto.randomUUID(),nome:hNome.value,hora:hHora.value,ativo:hAtivo.checked};
  l=editH?l.map(x=>x.id===editH?obj:x):[...l,obj];
  await ref.set({lista:l},{merge:true});
  fechar("modalHorario");carregarHorarios();
}
async function excluirHorario(id){
  if(!confirm("Excluir?"))return;
  const ref=db.doc("config/notificacoes_horarios");
  const d=await ref.get();
  const l=d.data().lista.filter(x=>x.id!==id);
  await ref.set({lista:l},{merge:true});carregarHorarios();
}

/* TIPOS */
async function carregarTipos(){
  const d=await db.doc("config/notificacoes_tipos").get();
  const l=d.exists?d.data().lista||[]:[];
  listaTipos.innerHTML="";
  aTipo.innerHTML="<option value=''>Tipo</option>";
  l.forEach(t=>{
    listaTipos.innerHTML+=`
      <div class="item"><b>${t.nome}</b>
      <button onclick="editarTipo('${t.id}')">‚úèÔ∏è</button>
      <button onclick="excluirTipo('${t.id}')">üóëÔ∏è</button></div>`;
    if(t.ativo)aTipo.innerHTML+=`<option value="${t.id}">${t.nome}</option>`;
  });
}
function abrirTipo(){editT=null;tNome.value="";tDesc.value="";tAtivo.checked=true;modalTipo.style.display="flex"}
async function editarTipo(id){
  const d=await db.doc("config/notificacoes_tipos").get();
  const t=d.data().lista.find(x=>x.id===id);
  editT=id;tNome.value=t.nome;tDesc.value=t.descricao||"";tAtivo.checked=t.ativo;
  modalTipo.style.display="flex";
}
async function salvarTipo(){
  const ref=db.doc("config/notificacoes_tipos");
  const d=await ref.get();let l=d.exists?d.data().lista||[]:[];
  const obj={id:editT||crypto.randomUUID(),nome:tNome.value,descricao:tDesc.value,ativo:tAtivo.checked};
  l=editT?l.map(x=>x.id===editT?obj:x):[...l,obj];
  await ref.set({lista:l},{merge:true});
  fechar("modalTipo");carregarTipos();
}
async function excluirTipo(id){
  if(!confirm("Excluir?"))return;
  const ref=db.doc("config/notificacoes_tipos");
  const d=await ref.get();
  await ref.set({lista:d.data().lista.filter(x=>x.id!==id)},{merge:true});
  carregarTipos();
}

/* AUTOM√ÅTICAS */
async function carregarAutomaticas(){
  const d=await db.doc("config/notificacoes_automaticas").get();
  const l=d.exists?d.data().lista||[]:[];
  listaAutomaticas.innerHTML="";
  l.forEach(a=>{
    listaAutomaticas.innerHTML+=`
      <div class="item"><b>${a.titulo}</b>
      <button onclick="editarAutomatica('${a.id}')">‚úèÔ∏è</button>
      <button onclick="excluirAutomatica('${a.id}')">üóëÔ∏è</button></div>`;
  });
}
async function abrirAutomatica(){
  editA=null;aTitulo.value="";aMsg.value="";aAtivo.checked=true;
  document.querySelectorAll(".aGrupo").forEach(x=>x.checked=false);
  const d=await db.doc("config/notificacoes_horarios").get();
  aHorarios.innerHTML="";
  (d.exists?d.data().lista:[]).forEach(h=>{
    aHorarios.innerHTML+=`<label class="checkbox"><input type="checkbox" class="aHorario" value="${h.id}">${h.nome}</label>`;
  });
  modalAutomatica.style.display="flex";
}
async function editarAutomatica(id){
  const d=await db.doc("config/notificacoes_automaticas").get();
  const a=d.data().lista.find(x=>x.id===id);
  editA=id;aTitulo.value=a.titulo;aMsg.value=a.mensagem;aAtivo.checked=a.ativo;
  abrirAutomatica();
  aTipo.value=a.tipo;
}
async function salvarAutomatica(){
  const ref=db.doc("config/notificacoes_automaticas");
  const d=await ref.get();let l=d.exists?d.data().lista||[]:[];
  const obj={
    id:editA||crypto.randomUUID(),
    tipo:aTipo.value,
    titulo:aTitulo.value,
    mensagem:aMsg.value,
    ativo:aAtivo.checked,
    grupos:[...document.querySelectorAll(".aGrupo:checked")].map(x=>x.value),
    horarios:[...document.querySelectorAll(".aHorario:checked")].map(x=>x.value)
  };
  l=editA?l.map(x=>x.id===editA?obj:x):[...l,obj];
  await ref.set({lista:l},{merge:true});
  fechar("modalAutomatica");carregarAutomaticas();
}
async function excluirAutomatica(id){
  if(!confirm("Excluir?"))return;
  const ref=db.doc("config/notificacoes_automaticas");
  const d=await ref.get();
  await ref.set({lista:d.data().lista.filter(x=>x.id!==id)},{merge:true});
  carregarAutomaticas();
}

/* MANUAL */
async function salvarManual(){
  if(!mTitulo.value||!mMsg.value)return alert("Preencha");
  await db.collection("notificacoes_manuais").add({
    titulo:mTitulo.value,mensagem:mMsg.value,
    data:mData.value,hora:mHora.value,
    criado_em:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Salvo");
  mTitulo.value="";mMsg.value="";
}
</script>

<script src="../login/logout.js"></script>
</body>
</html>