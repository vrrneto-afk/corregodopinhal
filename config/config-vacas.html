<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Vacas</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"config", chave:"config-vacas" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
.label-check{display:flex;align-items:center;gap:8px;font-weight:600;margin-top:12px}
.label-check input{margin:0}
.regra-card span{font-size:13px;font-weight:500}
.range{display:flex;gap:8px;align-items:center}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Vacas</h2>

<!-- PAR√ÇMETROS -->
<fieldset>
  <label>Gesta√ß√£o (meses)</label>
  <input type="number" id="gestacao_meses" min="0">

  <label>Idade m√≠nima para prenhez (meses)</label>
  <input type="number" id="idade_minima_meses" min="0">
</fieldset>

<button class="salvar" onclick="salvarParametros()">üíæ Salvar par√¢metros gerais</button>

<!-- TEXTOS -->
<h3 style="margin-top:20px;color:var(--marrom)">Textos ‚Äì Prenhez</h3>
<fieldset>
  <label>Antes do parto</label>
  <input type="text" id="txt_antes_parto" placeholder="Faltam {{dias}} dias">

  <label>Parto hoje</label>
  <input type="text" id="txt_parto_hoje">

  <label>Parto atrasado</label>
  <input type="text" id="txt_parto_atrasado" placeholder="Parto atrasado em {{dias}} dias">
</fieldset>

<button class="salvar" onclick="salvarTextos()">üíæ Salvar textos</button>

<!-- REGRAS -->
<h3 style="margin-top:22px;color:var(--marrom)">Regras de Prenhez</h3>
<div class="cards-grid" id="lista-regras"></div>

<!-- EDITOR -->
<div id="editor" class="hidden">
<fieldset>

  <label>Classe</label>
  <select id="classe">
    <option value="ok">OK</option>
    <option value="atencao">Aten√ß√£o</option>
    <option value="alerta">Alerta</option>
    <option value="urgente">Urgente</option>
  </select>

  <label>Dias antes do parto</label>
  <div class="range">
    <input type="number" id="dias_de" min="1" placeholder="De">
    <span>at√©</span>
    <input type="number" id="dias_ate" min="1" placeholder="At√©">
  </div>

  <label>Mensagem</label>
  <input type="text" id="mensagem">

  <label class="label-check">
    <input type="checkbox" id="ativa"> Regra ativa
  </label>

</fieldset>

<button class="salvar" onclick="salvarRegra()">üíæ Salvar regra</button>
<button class="voltar hidden" id="btn-excluir" onclick="excluirRegra()">üóëÔ∏è Excluir</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar</button>

</div>

<!-- MENU -->
<script>
fetch("../menu/menu-adm.html")
.then(r=>r.text())
.then(html=>{
  menu-adm.innerHTML=html;
  const s=document.createElement("script");
  s.src="../menu/menu-permissoes.js";
  s.onload=()=>{document.body.style.display="block";carregar();}
  document.body.appendChild(s);
});
</script>

<script>
const db=firebase.firestore();
let intervalos=[],editando=null;

async function carregar(){
  const snap=await db.collection("config").doc("vacas").get();
  if(!snap.exists) return;
  const d=snap.data();

  gestacao_meses.value=d.gestacao_meses||"";
  idade_minima_meses.value=d.idade_minima_meses||"";

  intervalos=d.prenhez_intervalos||[];

  txt_antes_parto.value=d.prenhez_textos?.antes_parto||"";
  txt_parto_hoje.value=d.prenhez_textos?.parto_hoje||"";
  txt_parto_atrasado.value=d.prenhez_textos?.parto_atrasado||"";

  renderizar();
}

function renderizar(){
  lista-regras.innerHTML="";
  intervalos.forEach((r,i)=>{
    if(r.ativa===false) return;
    const b=document.createElement("button");
    b.className="config-card regra-card";
    b.onclick=()=>editar(i);
    b.innerHTML=`
      <strong>${r.classe.toUpperCase()}</strong>
      <span>${r.dias_de} at√© ${r.dias_ate} dias</span>
      <span>${r.mensagem||""}</span>`;
    lista-regras.appendChild(b);
  });

  const n=document.createElement("button");
  n.className="config-card";
  n.innerHTML="‚ûï Nova regra";
  n.onclick=nova;
  lista-regras.appendChild(n);
}

function nova(){editando=null;limpar();btn-excluir.classList.add("hidden");editor.classList.remove("hidden")}
function editar(i){
  editando=i;
  const r=intervalos[i];
  classe.value=r.classe;
  dias_de.value=r.dias_de;
  dias_ate.value=r.dias_ate;
  mensagem.value=r.mensagem;
  ativa.checked=r.ativa!==false;
  btn-excluir.classList.remove("hidden");
  editor.classList.remove("hidden");
}

async function salvarRegra(){
  const obj={
    classe:classe.value,
    dias_de:Number(dias_de.value),
    dias_ate:Number(dias_ate.value),
    mensagem:mensagem.value.trim(),
    ativa:ativa.checked
  };
  if(obj.dias_de>obj.dias_ate){alert("Intervalo inv√°lido");return;}
  if(editando===null) intervalos.push(obj);
  else intervalos[editando]=obj;
  await salvarFirestore();
  cancelar();renderizar();
}

async function salvarParametros(){
  await db.collection("config").doc("vacas").update({
    gestacao_meses:Number(gestacao_meses.value),
    idade_minima_meses:Number(idade_minima_meses.value)
  });
  alert("Par√¢metros salvos.");
}

async function salvarTextos(){
  await db.collection("config").doc("vacas").update({
    prenhez_textos:{
      antes_parto:txt_antes_parto.value,
      parto_hoje:txt_parto_hoje.value,
      parto_atrasado:txt_parto_atrasado.value
    }
  });
  alert("Textos salvos.");
}

async function excluirRegra(){
  if(editando===null) return;
  intervalos.splice(editando,1);
  await salvarFirestore();
  cancelar();renderizar();
}

async function salvarFirestore(){
  await db.collection("config").doc("vacas").update({
    gestacao_meses:Number(gestacao_meses.value),
    idade_minima_meses:Number(idade_minima_meses.value),
    prenhez_intervalos:intervalos
  });
}

function cancelar(){editor.classList.add("hidden");limpar()}
function limpar(){
  classe.value="ok";
  dias_de.value="";
  dias_ate.value="";
  mensagem.value="";
  ativa.checked=true;
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>
