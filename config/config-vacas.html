<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Vacas</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = { area:"config", chave:"config-vacas" };
</script>

<script src="../login/auth-guard.js"></script>

<style>
.label-check{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:6px;
  font-weight:600;
  margin-top:12px;
  width:100%;
}
.label-check input{margin:0}
.regra-card span{font-size:13px;font-weight:500}
.range{display:flex;align-items:center;gap:8px}
.info{font-size:13px;opacity:.75;margin:10px 0 14px}
.small{font-size:12px;opacity:.6}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Vacas</h2>

<!-- PAR√ÇMETROS -->
<fieldset>
  <label>Gesta√ß√£o (meses)</label>
  <input type="number" id="gestacao_meses" min="0">

  <label>Idade m√≠nima para prenhez (meses)</label>
  <input type="number" id="idade_minima_meses" min="0">
</fieldset>

<button class="salvar" onclick="salvarParametros()">üíæ Salvar par√¢metros gerais</button>

<!-- TEXTOS -->
<h3 style="margin-top:20px;color:var(--marrom)">Textos ‚Äì Prenhez (refer√™ncia)</h3>
<fieldset>
  <label>Antes do parto</label>
  <input type="text" id="txt_antes_parto" placeholder="‚è≥ Faltam {{dias}} dias">

  <label>Dia previsto do parto</label>
  <input type="text" id="txt_parto_hoje" placeholder="üìÖ Parto previsto para HOJE">

  <label>Ap√≥s a data prevista</label>
  <input type="text" id="txt_parto_atrasado" placeholder="üö® Parto atrasado em {{dias}} dias">
</fieldset>

<button class="salvar" onclick="salvarTextos()">üíæ Salvar textos</button>

<!-- REGRAS -->
<h3 style="margin-top:22px;color:var(--marrom)">R√©gua de aten√ß√£o (antes do parto)</h3>

<p class="info">
As regras abaixo servem apenas como refer√™ncia visual para <strong>dias antes do parto (‚â• 1)</strong>.
Datas iguais ou posteriores ao dia previsto s√£o tratadas apenas pelos textos acima.
</p>

<div class="cards-grid" id="lista-regras"></div>

<!-- EDITOR -->
<div id="editor" class="hidden">
<fieldset>

  <label>Classe visual</label>
  <select id="classe">
    <option value="ok">OK</option>
    <option value="atencao">Aten√ß√£o</option>
    <option value="alerta">Alerta</option>
    <option value="urgente">Urgente</option>
  </select>

  <label>Dias antes do parto</label>
  <div class="range">
    <input type="number" id="dias_de" min="1" placeholder="De">
    <span>at√©</span>
    <input type="number" id="dias_ate" min="1" placeholder="At√©">
  </div>

  <label>Mensagem auxiliar</label>
  <input type="text" id="mensagem">

  <label class="label-check">
    <input type="checkbox" id="ativa">
    <span>Regra ativa</span>
  </label>

</fieldset>

<button class="salvar" onclick="salvarRegra()">üíæ Salvar regra</button>
<button class="voltar hidden" id="btn-excluir" onclick="excluirRegra()">üóëÔ∏è Excluir regra</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar</button>

</div>

<!-- MENU -->
<script>
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;
    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => {
      document.body.style.display = "block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const db = firebase.firestore();

const elListaRegras = document.getElementById("lista-regras");
const editor = document.getElementById("editor");
const btnExcluir = document.getElementById("btn-excluir");

let intervalos = [];
let editando = null;

function gerarId(classe, de, ate){
  return `${classe}_${de}_${ate}`;
}

/* LOAD */
async function carregar(){
  const snap = await db.collection("config").doc("vacas").get();
  if(!snap.exists) return;

  const d = snap.data();

  gestacao_meses.value     = d.gestacao_meses ?? "";
  idade_minima_meses.value = d.idade_minima_meses ?? "";

  intervalos = d.prenhez_intervalos || [];

  txt_antes_parto.value    = d.prenhez_textos?.antes_parto || "";
  txt_parto_hoje.value     = d.prenhez_textos?.parto_hoje || "";
  txt_parto_atrasado.value = d.prenhez_textos?.parto_atrasado || "";

  renderizar();
}

/* RENDER */
function renderizar(){
  elListaRegras.innerHTML = "";

  intervalos.forEach((r,i)=>{
    if(r.ativa === false) return;

    const b = document.createElement("button");
    b.className = "config-card regra-card";
    b.onclick = ()=>editar(i);
    b.innerHTML = `
      <strong>${r.classe.toUpperCase()}</strong>
      <span>${r.dias_de} at√© ${r.dias_ate} dias</span>
      <span>${r.mensagem || ""}</span>
      <span class="small">ID: ${r.id}</span>
    `;
    elListaRegras.appendChild(b);
  });

  const novo = document.createElement("button");
  novo.className = "config-card";
  novo.innerHTML = "‚ûï Nova regra";
  novo.onclick = nova;
  elListaRegras.appendChild(novo);
}

/* EDITOR */
function nova(){
  editando = null;
  limpar();
  btnExcluir.classList.add("hidden");
  editor.classList.remove("hidden");
}

function editar(i){
  editando = i;
  const r = intervalos[i];

  classe.value = r.classe;
  dias_de.value = r.dias_de;
  dias_ate.value = r.dias_ate;
  mensagem.value = r.mensagem || "";
  ativa.checked = r.ativa !== false;

  btnExcluir.classList.remove("hidden");
  editor.classList.remove("hidden");
}

/* SALVAR */
async function salvarRegra(){
  const de = Number(dias_de.value);
  const ate = Number(dias_ate.value);

  if(isNaN(de) || isNaN(ate) || de < 1 || de > ate){
    alert("Informe um intervalo v√°lido (dias ‚â• 1).");
    return;
  }

  const obj = {
    id: gerarId(classe.value, de, ate),
    classe: classe.value,
    dias_de: de,
    dias_ate: ate,
    mensagem: mensagem.value.trim(),
    ativa: ativa.checked
  };

  if(editando === null) intervalos.push(obj);
  else intervalos[editando] = obj;

  await salvarFirestore();
  cancelar();
  renderizar();
}

/* PARAMETROS */
async function salvarParametros(){
  await db.collection("config").doc("vacas").update({
    gestacao_meses: Number(gestacao_meses.value),
    idade_minima_meses: Number(idade_minima_meses.value)
  });
  alert("Par√¢metros gerais salvos.");
}

/* TEXTOS */
async function salvarTextos(){
  await db.collection("config").doc("vacas").update({
    prenhez_textos:{
      antes_parto: txt_antes_parto.value,
      parto_hoje: txt_parto_hoje.value,
      parto_atrasado: txt_parto_atrasado.value
    }
  });
  alert("Textos salvos.");
}

/* EXCLUIR */
async function excluirRegra(){
  if(editando === null) return;
  if(!confirm("Deseja excluir esta regra?")) return;

  intervalos.splice(editando,1);
  await salvarFirestore();
  cancelar();
  renderizar();
}

async function salvarFirestore(){
  await db.collection("config").doc("vacas").update({
    gestacao_meses: Number(gestacao_meses.value),
    idade_minima_meses: Number(idade_minima_meses.value),
    prenhez_intervalos: intervalos
  });
}

/* AUX */
function cancelar(){
  editor.classList.add("hidden");
  limpar();
}
function limpar(){
  classe.value = "ok";
  dias_de.value = "";
  dias_ate.value = "";
  mensagem.value = "";
  ativa.checked = true;
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>
