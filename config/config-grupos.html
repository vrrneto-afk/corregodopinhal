<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Grupos</title>

<!-- MANIFEST -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- CONFIG CSS -->
<link rel="stylesheet" href="./config.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<!-- PERMISS√ÉO DA P√ÅGINA -->
<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-grupos"
};
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
.permissoes-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
  margin-top:10px;
}
.perm-item{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Grupos de Usu√°rios</h2>
<div class="cards-grid" id="lista-grupos"></div>

<div id="editor" class="hidden">
<fieldset>

<label>ID do grupo</label>
<input id="grupo_id">

<label>Nome do grupo</label>
<input id="grupo_nome">

<hr>

<h3>üì± App</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="inicio">In√≠cio</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="tempo">Tempo</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="lembretes">Lembretes</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="animais">Animais</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="vacas">Vacas</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="bezerros">Bezerros</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="historico">Hist√≥rico</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="farmacia">Farm√°cia</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="vacinas">Vacinas</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="leite">Leite</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="despesas">Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="clima">Clima</label>

</div>

  <h3>üöú Trator</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-inicio">In√≠cio</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-painel">Painel Trator</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-cadservicos">Cadastro de Servi√ßos</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-caddespesas">Cadastro de Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-servicos">Servi√ßos</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-despesas">Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-financeiro">Relat√≥rio Financeiro</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-motorista">Motorista</label>
<label class="perm-item"><input type="checkbox" data-area="trator" data-pagina="trator-cadmotorista">Cadastro de Motorista</label>

</div>
  
<h4>üìä Relat√≥rios</h4>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="relatorios" data-pagina="relatorio">Relat√≥rios</label>
<label class="perm-item"><input type="checkbox" data-area="relatorios" data-pagina="relatorio-financeiro">Financeiro</label>
<label class="perm-item"><input type="checkbox" data-area="relatorios" data-pagina="relatorio-leite">Produ√ß√£o de Leite</label>
<label class="perm-item"><input type="checkbox" data-area="relatorios" data-pagina="relatorio-rebanho">Rebanho</label>
<label class="perm-item"><input type="checkbox" data-area="relatorios" data-pagina="relatorio-sanitario">Sanit√°rio</label>
</div>

<hr>

<h3>üßæ √Årea Administrativa</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="login">Login</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_animais">Animais</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_farmacia">Farm√°cia</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_vacinas">Vacinas</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_eventos">Eventos</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_leite">Leite</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_despesas">Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="adm" data-pagina="cadastro_fotos">Fotos</label>
</div>

<hr>

<h3>‚öôÔ∏è Configura√ß√µes</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config">Painel Config</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-geral">Geral</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-bezerros">Bezerros</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-vacinas">Vacinas</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-vacas">Vacas</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-leite">Leite</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-despesas">Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-especies">Esp√©cies</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-farmacia">Farm√°cia</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-clima">Clima</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-menu">Menu</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-grupos">Grupos</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-usuarios">Usu√°rios</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="tudo">Acesso total</label>
</div>

</fieldset>

<button class="salvar" onclick="salvarGrupo()">üíæ Salvar</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar para Configura√ß√µes</button>

</div>

<!-- MENU + PERMISS√ïES (PADR√ÉO GLOBAL CORRETO) -->
<script>
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu-adm").innerHTML = html;

    // ‚úÖ MARCA O LINK ATIVO (ERA O QUE FALTAVA)
    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("config.html")){
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => {
      document.body.style.display = "block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const db = firebase.firestore();

let grupos = [];
let editando = null;

async function carregar(){
  const s = await db.collection("config").doc("grupos").get();
  grupos = s.exists ? s.data().lista || [] : [];
  render();
}

function render(){
  const area = document.getElementById("lista-grupos");
  area.innerHTML = "";

  grupos.forEach((g,i)=>{
    const b = document.createElement("button");
    b.className = "config-card";
    b.innerHTML = `<strong>${g.nome}</strong><span>ID: ${g.id}</span>`;
    b.onclick = () => editar(i);
    area.appendChild(b);
  });

  const novo = document.createElement("button");
  novo.className = "config-card";
  novo.innerHTML = "‚ûï Novo grupo";
  novo.onclick = novoGrupo;
  area.appendChild(novo);
}

function novoGrupo(){
  editando = null;
  grupo_id.value = "";
  grupo_nome.value = "";
  document.querySelectorAll("input[type=checkbox]").forEach(c => c.checked = false);
  editor.classList.remove("hidden");
}

function editar(i){
  editando = i;
  const g = grupos[i];
  grupo_id.value = g.id;
  grupo_nome.value = g.nome;

  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    c.checked = g.permissoes?.[c.dataset.area]?.[c.dataset.pagina] === true;
  });

  editor.classList.remove("hidden");
}

function cancelar(){
  editor.classList.add("hidden");
  editando = null;
}

async function salvarGrupo(){
  const permissoes = {};

  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    const area = c.dataset.area;
    const pag  = c.dataset.pagina;

    permissoes[area] = permissoes[area] || {};
    permissoes[area][pag] = c.checked === true;
  });

  if(!grupo_id.value.trim() || !grupo_nome.value.trim()){
    alert("Informe o ID e o nome do grupo.");
    return;
  }

  const obj = {
    id: grupo_id.value.trim(),
    nome: grupo_nome.value.trim(),
    permissoes
  };

  if(editando === null) grupos.push(obj);
  else grupos[editando] = obj;

  await db.collection("config").doc("grupos").set({ lista: grupos }, { merge:true });

  alert("Grupo salvo com sucesso.");
  location.reload();
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>
