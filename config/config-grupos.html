<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Grupos</title>

<!-- MANIFEST -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- CONFIG CSS -->
<link rel="stylesheet" href="./config.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<!-- PERMISS√ÉO GLOBAL -->
<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-grupos"
};
</script>

<!-- AUTH GUARD GLOBAL -->
<script src="../login/auth-guard.js"></script>
</head>

<body>

<header>‚öôÔ∏è Configura√ß√µes</header>

<div id="menu-adm"></div>

<div class="container">

<h2>Configura√ß√£o ‚Äì Grupos de Usu√°rios</h2>

<div class="cards-grid" id="lista-grupos"></div>

<div id="editor" class="hidden">
<fieldset>

<label>ID do grupo</label>
<input id="grupo_id">

<label>Nome do grupo</label>
<input id="grupo_nome">

<hr>

<h3>üì± App</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="inicio"> In√≠cio</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="animais"> Animais</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="vacas"> Vacas</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="bezerros"> Bezerros</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="leite"> Leite</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="despesas"> Despesas</label>
<label class="perm-item"><input type="checkbox" data-area="app" data-pagina="clima"> Clima</label>
</div>

<hr>

<h3>‚öôÔ∏è Configura√ß√µes</h3>
<div class="permissoes-grid">
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config"> Painel</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-grupos"> Grupos</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="config-usuarios"> Usu√°rios</label>
<label class="perm-item"><input type="checkbox" data-area="config" data-pagina="tudo"> Acesso total</label>
</div>

</fieldset>

<button class="salvar" onclick="salvarGrupo()">üíæ Salvar</button>
<button class="voltar" onclick="cancelar()">Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar para Configura√ß√µes
</button>

</div>

<script>
/* MENU */
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;
  });

const db = firebase.firestore();
let grupos = [];
let editando = null;

async function carregar(){
  const snap = await db.collection("config").doc("grupos").get();
  grupos = snap.exists ? snap.data().lista || [] : [];
  render();
}

function render(){
  const area = document.getElementById("lista-grupos");
  area.innerHTML = "";

  grupos.forEach((g,i)=>{
    const b = document.createElement("button");
    b.className="config-card";
    b.innerHTML=`<strong>${g.nome}</strong><span>${g.id}</span>`;
    b.onclick=()=>editar(i);
    area.appendChild(b);
  });

  const novo=document.createElement("button");
  novo.className="config-card";
  novo.innerText="‚ûï Novo grupo";
  novo.onclick=novoGrupo;
  area.appendChild(novo);
}

function novoGrupo(){
  editando=null;
  grupo_id.value="";
  grupo_nome.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
  editor.classList.remove("hidden");
}

function editar(i){
  editando=i;
  const g=grupos[i];
  grupo_id.value=g.id;
  grupo_nome.value=g.nome;

  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    c.checked = g.permissoes?.[c.dataset.area]?.[c.dataset.pagina] === true;
  });

  editor.classList.remove("hidden");
}

async function salvarGrupo(){
  const id=grupo_id.value.trim();
  const nome=grupo_nome.value.trim();
  if(!id||!nome) return alert("Informe ID e nome.");

  const permissoes={};
  document.querySelectorAll("input[type=checkbox]").forEach(c=>{
    if(c.checked){
      permissoes[c.dataset.area] ??= {};
      permissoes[c.dataset.area][c.dataset.pagina]=true;
    }
  });

  const obj={id,nome,permissoes};
  if(editando===null) grupos.push(obj);
  else grupos[editando]=obj;

  await db.collection("config").doc("grupos").set({lista:grupos});
  cancelar();
  render();
}

function cancelar(){
  editor.classList.add("hidden");
  editando=null;
}

carregar();
</script>

<script src="../login/logout.js"></script>

</body>
</html>