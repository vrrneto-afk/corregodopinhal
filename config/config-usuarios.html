<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<!-- MANIFEST -->
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">

<!-- CONFIG CSS -->
<link rel="stylesheet" href="./config.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<!-- IDENTIFICA√á√ÉO DA P√ÅGINA -->
<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-usuarios"
};
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
.status{
  font-weight:700;
  font-size:13px;
}
.status.ativo{color:#2f6b2f}
.status.bloqueado{color:#c0392b}
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:8px;
}
.actions button{
  font-size:13px;
}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Usu√°rios do Sistema</h2>

<div class="cards-grid" id="lista-usuarios"></div>

<hr>

<h3>‚ûï Criar novo usu√°rio</h3>

<fieldset>
  <label>Nome</label>
  <input id="novo_nome">

  <label>Email</label>
  <input id="novo_email" type="email">

  <label>Grupo</label>
  <select id="novo_grupo">
    <!-- carregado dinamicamente -->
  </select>
</fieldset>

<button class="salvar" onclick="criarUsuario()">üíæ Criar usu√°rio</button>

<button class="voltar" onclick="location.href='config.html'">
‚¨Ö Voltar
</button>

</div>

<!-- MENU + PERMISS√ïES -->
<script>
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu-adm").innerHTML = html;

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => {
      document.body.style.display = "block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const auth = firebase.auth();
const db   = firebase.firestore();

let usuarios = [];
let grupos   = [];

/* LOAD */
async function carregar(){
  const g = await db.collection("config").doc("grupos").get();
  grupos = g.exists ? g.data().lista || [] : [];

  const sel = document.getElementById("novo_grupo");
  sel.innerHTML = "";
  grupos.forEach(gr=>{
    const o = document.createElement("option");
    o.value = gr.id;
    o.textContent = gr.nome;
    sel.appendChild(o);
  });

  const s = await db.collection("usuarios").get();
  usuarios = s.docs.map(d=>({_id:d.id,...d.data()}));

  render();
}

/* RENDER */
function render(){
  const area = document.getElementById("lista-usuarios");
  area.innerHTML = "";

  usuarios.forEach(u=>{
    const div = document.createElement("div");
    div.className = "config-card";

    div.innerHTML = `
      <strong>${u.nome || "-"}</strong>
      <span>${u.email}</span>
      <span>Grupo: ${u.papel}</span>
      <span class="status ${u.ativo!==false?"ativo":"bloqueado"}">
        ${u.ativo!==false?"Ativo":"Bloqueado"}
      </span>

      <div class="actions">
        <button onclick="resetarSenha('${u.email}')">üîë Reset senha</button>
        <button onclick="toggleAtivo('${u._id}', ${u.ativo!==false})">
          ${u.ativo!==false?"üö´ Bloquear":"‚úÖ Ativar"}
        </button>
        <button onclick="excluirUsuario('${u._id}','${u.email}')" style="background:#c0392b;color:#fff">
          üóë Excluir
        </button>
      </div>
    `;

    area.appendChild(div);
  });
}

/* CRIAR USU√ÅRIO */
async function criarUsuario(){
  const nome  = novo_nome.value.trim();
  const email = novo_email.value.trim();
  const papel = novo_grupo.value;

  if(!nome || !email){
    alert("Informe nome e email.");
    return;
  }

  // cria auth
  const tempSenha = Math.random().toString(36).slice(-8);

  const cred = await auth.createUserWithEmailAndPassword(email, tempSenha);

  await db.collection("usuarios").doc(cred.user.uid).set({
    nome,
    email,
    papel,
    ativo:true,
    criado_em: firebase.firestore.FieldValue.serverTimestamp()
  });

  await auth.sendPasswordResetEmail(email);

  alert("Usu√°rio criado. Email de redefini√ß√£o enviado.");

  novo_nome.value="";
  novo_email.value="";

  carregar();
}

/* RESETAR SENHA */
function resetarSenha(email){
  if(!confirm("Enviar email de redefini√ß√£o de senha?")) return;
  auth.sendPasswordResetEmail(email);
  alert("Email enviado.");
}

/* BLOQUEAR / ATIVAR */
async function toggleAtivo(id, ativoAtual){
  await db.collection("usuarios").doc(id).update({
    ativo: !ativoAtual
  });
  carregar();
}

/* EXCLUIR */
async function excluirUsuario(id,email){
  if(!confirm("Excluir usu√°rio definitivamente?")) return;

  await db.collection("usuarios").doc(id).delete();
  alert("Usu√°rio removido do sistema (auth deve ser removido manualmente).");

  carregar();
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>