<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<!-- MENU GLOBAL -->
<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<!-- IDENTIFICA√á√ÉO DA P√ÅGINA -->
<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-usuarios"
};
</script>

<!-- AUTH GUARD -->
<script src="../login/auth-guard.js"></script>

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:600;
}
.check-row input{margin:0;}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Usu√°rios do Sistema</h2>
<div class="cards-grid" id="lista"></div>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input id="edit_nome">

<label>Email</label>
<input id="edit_email">

<label>Grupo</label>
<select id="edit_grupo"></select>

<div class="check-row">
  <input type="checkbox" id="edit_ativo">
  <label for="edit_ativo">Usu√°rio ativo</label>
</div>

</fieldset>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button class="voltar" onclick="resetSenha()">üîë Reenviar senha</button>
<button class="voltar" onclick="excluir()" style="background:#c0392b;color:#fff">üóë Excluir</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar</button>

</div>

<!-- MENU -->
<script>
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("config.html")){
        a.classList.add("ativo");
      }
    });

    const s=document.createElement("script");
    s.src="../menu/menu-permissoes.js";
    s.onload=()=>{
      document.body.style.display="block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const db   = firebase.firestore();
const auth = firebase.auth();

/* AUTH SECUND√ÅRIO (cria√ß√£o segura) */
const secondaryApp = firebase.initializeApp(
  firebase.app().options,
  "Secondary"
);
const secondaryAuth = secondaryApp.auth();

let usuarios = [];
let grupos   = [];
let usuarioAtual = null;

/* ================= LOAD ================= */
async function carregar(){
  const g = await db.collection("config").doc("grupos").get();
  grupos = g.exists ? g.data().lista || [] : [];

  const snap = await db
    .collection("config")
    .doc("usuarios")
    .collection("lista")
    .get();

  usuarios = snap.docs.map(d=>({_id:d.id,...d.data()}));
  render();
}

/* ================= RENDER ================= */
function render(){
  lista.innerHTML="";

  usuarios.forEach(u=>{
    const b=document.createElement("button");
    b.className="config-card";
    b.innerHTML=`
      <strong>${u.nome||"-"}</strong>
      <span>${u.email}</span>
      <span>Grupo: ${u.papel}</span>
      <span style="color:${u.ativo!==false?"#2f6b2f":"#c0392b"}">
        ${u.ativo!==false?"Ativo":"Inativo"}
      </span>
    `;
    b.onclick=()=>editar(u);
    lista.appendChild(b);
  });

  const novo=document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Criar novo usu√°rio";
  novo.onclick=criarNovo;
  lista.appendChild(novo);
}

/* ================= EDITAR ================= */
function editar(u){
  usuarioAtual = u;

  edit_nome.value  = u.nome || "";
  edit_email.value = u.email;
  edit_email.disabled = true;
  edit_ativo.checked = u.ativo !== false;

  preencherGrupos(u.papel);
  editor.classList.remove("hidden");
}

/* ================= NOVO ================= */
function criarNovo(){
  usuarioAtual = null;
  edit_nome.value="";
  edit_email.value="";
  edit_email.disabled=false;
  edit_ativo.checked=true;

  preencherGrupos(null);
  editor.classList.remove("hidden");
}

function preencherGrupos(sel){
  edit_grupo.innerHTML="";
  grupos.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id;
    o.textContent=g.nome;
    if(g.id===sel) o.selected=true;
    edit_grupo.appendChild(o);
  });
}

function cancelar(){
  editor.classList.add("hidden");
}

/* ================= SALVAR ================= */
async function salvar(){
  const nome  = edit_nome.value.trim();
  const email = edit_email.value.trim();
  const grupo = edit_grupo.value;
  const ativo = edit_ativo.checked;

  if(!nome){
    alert("Informe o nome.");
    return;
  }

  /* ===== CRIA√á√ÉO ===== */
  if(!usuarioAtual){
    if(!email){
      alert("Informe o email.");
      return;
    }

    try{
      const senhaTemp = Math.random().toString(36).slice(-10);
      const cred = await secondaryAuth.createUserWithEmailAndPassword(email, senhaTemp);

      await db.collection("config")
        .doc("usuarios")
        .collection("lista")
        .doc(cred.user.uid)
        .set({
          nome,
          email,
          papel:grupo,
          ativo:true,
          criado_em: firebase.firestore.FieldValue.serverTimestamp()
        });

      await secondaryAuth.sendPasswordResetEmail(email);
      await secondaryAuth.signOut();

      alert("Usu√°rio criado com sucesso. Email enviado.");
      location.reload();
    }catch(e){
      alert("Erro ao criar usu√°rio: " + e.message);
    }
    return;
  }

  /* ===== EDI√á√ÉO ===== */
  try{
    await db.collection("config")
      .doc("usuarios")
      .collection("lista")
      .doc(usuarioAtual._id)
      .update({ nome, papel:grupo, ativo });

    alert("Dados atualizados com sucesso.");
    location.reload();
  }catch(e){
    alert("Erro ao salvar: " + e.message);
  }
}

/* ================= RESET ================= */
function resetSenha(){
  if(!confirm("Reenviar email de redefini√ß√£o de senha?")) return;
  auth.sendPasswordResetEmail(edit_email.value);
  alert("Email enviado.");
}

/* ================= EXCLUIR ================= */
async function excluir(){
  if(!usuarioAtual) return;

  if(!confirm(`Excluir o usu√°rio ${usuarioAtual.nome}?`)) return;

  try{
    await db.collection("config")
      .doc("usuarios")
      .collection("lista")
      .doc(usuarioAtual._id)
      .delete();

    alert("Usu√°rio removido. Acesso revogado imediatamente.");
    location.reload();
  }catch(e){
    alert("Erro ao excluir: " + e.message);
  }
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>