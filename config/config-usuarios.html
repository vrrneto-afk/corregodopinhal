<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-usuarios"
};
</script>

<script src="../login/auth-guard.js"></script>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<h2>Usu√°rios do Sistema</h2>
<div class="cards-grid" id="lista"></div>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input id="edit_nome">

<label>Email</label>
<input id="edit_email">

<label>Grupo</label>
<select id="edit_grupo"></select>

<label style="margin-top:10px">
<input type="checkbox" id="edit_ativo"> Usu√°rio ativo
</label>

</fieldset>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button class="voltar" onclick="resetSenha()">üîë Reenviar senha</button>
<button class="voltar" onclick="excluir()" style="background:#c0392b;color:#fff">üóë Excluir</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar</button>

</div>

<script>
fetch("../menu/menu-adm.html")
  .then(r=>r.text())
  .then(html=>{
    document.getElementById("menu-adm").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("config.html")){
        a.classList.add("ativo");
      }
    });

    const s=document.createElement("script");
    s.src="../menu/menu-permissoes.js";
    s.onload=()=>{
      document.body.style.display="block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const db = firebase.firestore();
const auth = firebase.auth();

/* üîê AUTH SECUND√ÅRIO (ISOLADO) */
const secondaryApp = firebase.initializeApp(
  firebase.app().options,
  "Secondary"
);
const secondaryAuth = secondaryApp.auth();

let usuarios=[];
let grupos=[];
let editando=null;

async function carregar(){
  const g = await db.collection("config").doc("grupos").get();
  grupos = g.exists ? g.data().lista||[] : [];

  const s = await db.collection("usuarios").get();
  usuarios = s.docs.map(d=>({_id:d.id,...d.data()}));

  render();
}

function render(){
  lista.innerHTML="";

  usuarios.forEach((u,i)=>{
    const b=document.createElement("button");
    b.className="config-card";
    b.innerHTML=`
      <strong>${u.nome||"-"}</strong>
      <span>${u.email}</span>
      <span>Grupo: ${u.papel}</span>
      <span style="color:${u.ativo!==false?"#2f6b2f":"#c0392b"}">
        ${u.ativo!==false?"Ativo":"Inativo"}
      </span>
    `;
    b.onclick=()=>editar(i);
    lista.appendChild(b);
  });

  const novo=document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Criar novo usu√°rio";
  novo.onclick=criarNovo;
  lista.appendChild(novo);
}

function editar(i){
  usuarioAtual = usuarios[i];

  edit_nome.value = usuarioAtual.nome || "";
  edit_email.value = usuarioAtual.email;
  edit_email.disabled = true;
  edit_ativo.checked = usuarioAtual.ativo !== false;

  preencherGrupos(usuarioAtual.papel);

  editor.classList.remove("hidden");
}

function criarNovo(){
  editando=null;
  edit_nome.value="";
  edit_email.value="";
  edit_email.disabled=false;
  edit_ativo.checked=true;

  preencherGrupos(null);

  editor.classList.remove("hidden");
}

function preencherGrupos(selecionado){
  edit_grupo.innerHTML="";
  grupos.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id;
    o.textContent=g.nome;
    if(g.id===selecionado) o.selected=true;
    edit_grupo.appendChild(o);
  });
}

function cancelar(){
  editor.classList.add("hidden");
}

/* üíæ SALVAR (CRIAR OU EDITAR) */
async function salvar(){
  const nome=edit_nome.value.trim();
  const email=edit_email.value.trim();
  const grupo=edit_grupo.value;
  const ativo=edit_ativo.checked;

  if(!nome){
    alert("Informe o nome.");
    return;
  }

  /* üÜï CRIA√á√ÉO */
  if(editando===null){
    if(!email){
      alert("Informe o email.");
      return;
    }

    const senhaTemp = Math.random().toString(36).slice(-10);

    try{
      const cred = await secondaryAuth.createUserWithEmailAndPassword(email, senhaTemp);

      await db.collection("usuarios").doc(cred.user.uid).set({
        nome,
        email,
        papel:grupo,
        ativo:true,
        criado_em: firebase.firestore.FieldValue.serverTimestamp()
      });

      await secondaryAuth.sendPasswordResetEmail(email);
      await secondaryAuth.signOut();

      alert("Usu√°rio criado. Email de redefini√ß√£o enviado.");
      location.reload();

    }catch(e){
      alert("Erro ao criar usu√°rio: " + e.message);
    }

    return;
  }

  /* ‚úèÔ∏è EDI√á√ÉO */
  await db.collection("usuarios").doc(usuarios[editando]._id).update({
    nome,
    papel:grupo,
    ativo
  });

  location.reload();
}

function resetSenha(){
  if(!confirm("Reenviar email de redefini√ß√£o de senha?")) return;
  auth.sendPasswordResetEmail(edit_email.value);
  alert("Email enviado.");
}

async function excluir(){
  if(!usuarioAtual){
    alert("Nenhum usu√°rio selecionado.");
    return;
  }

  if(!confirm(`Excluir o usu√°rio ${usuarioAtual.nome}?`)) return;

  try{
    await db.collection("usuarios").doc(usuarioAtual._id).delete();
    alert("Usu√°rio removido do sistema.");
    location.reload();
  }catch(e){
    alert("Erro ao excluir usu√°rio: " + e.message);
  }
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>