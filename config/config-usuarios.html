<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configura√ß√£o ‚Äì Usu√°rios</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#7b3f2a">

<link rel="stylesheet" href="../menu/menu.css">
<link rel="stylesheet" href="./config.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>

<script>
window.PERMISSAO_PAGINA = {
  area: "config",
  chave: "config-usuarios"
};
</script>

<script src="../login/auth-guard.js"></script>

<style>
.check-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:600;
}
.check-row input{margin:0;}

.msg{
  padding:12px;
  border-radius:8px;
  margin-bottom:16px;
  font-weight:600;
}
.msg.sucesso{
  background:#e6f4ea;
  color:#2f6b2f;
}
.msg.erro{
  background:#fdecea;
  color:#c0392b;
}
.hidden{display:none;}
</style>
</head>

<body style="display:none">

<header>‚öôÔ∏è Configura√ß√µes</header>
<div id="menu-adm"></div>

<div class="container">

<div id="msg" class="msg hidden"></div>

<h2>Usu√°rios do Sistema</h2>
<div class="cards-grid" id="lista"></div>

<div id="editor" class="hidden">
<fieldset>

<label>Nome</label>
<input id="edit_nome">

<label>Usu√°rio</label>
<input id="edit_usuario">

<label>Email</label>
<input id="edit_email">

<label>Grupo</label>
<select id="edit_grupo"></select>

<div class="check-row">
  <input type="checkbox" id="edit_ativo">
  <label for="edit_ativo">Usu√°rio ativo</label>
</div>

</fieldset>

<button class="salvar" onclick="salvar()">üíæ Salvar</button>
<button class="voltar" onclick="resetSenha()">üîë Reenviar senha</button>
<button class="voltar" onclick="excluir()" style="background:#c0392b;color:#fff">üóë Excluir</button>
<button class="voltar" onclick="cancelar()">‚ùå Cancelar</button>
</div>

<button class="voltar" onclick="location.href='config.html'">‚¨Ö Voltar</button>

</div>

<!-- MENU + PERMISS√ïES (PADR√ÉO GLOBAL CORRETO) -->
<script>
fetch("../menu/menu-adm.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("menu-adm").innerHTML = html;

    document.querySelectorAll(".menu-link").forEach(a=>{
      if(a.getAttribute("href")?.includes("config.html")){
        a.classList.add("ativo");
      }
    });

    const s = document.createElement("script");
    s.src = "../menu/menu-permissoes.js";
    s.onload = () => {
      document.body.style.display = "block";
      carregar();
    };
    document.body.appendChild(s);
  });
</script>

<script>
const db   = firebase.firestore();
const auth = firebase.auth();

/* AUTH SECUND√ÅRIO */
const secondaryApp = firebase.initializeApp(
  firebase.app().options,
  "Secondary"
);
const secondaryAuth = secondaryApp.auth();

let usuarios = [];
let grupos   = [];
let usuarioAtual = null;

function mensagem(texto, tipo="sucesso"){
  const m = document.getElementById("msg");
  m.textContent = texto;
  m.className = `msg ${tipo}`;
  m.classList.remove("hidden");
}

/* LOAD */
async function carregar(){
  const g = await db.collection("config").doc("grupos").get();
  grupos = g.exists ? g.data().lista || [] : [];

  const snap = await db.collection("usuarios").get();
  usuarios = snap.docs.map(d=>({_id:d.id,...d.data()}));

  render();
}

/* RENDER */
function render(){
  lista.innerHTML="";

  usuarios.forEach(u=>{
    const b=document.createElement("button");
    b.className="config-card";
    b.innerHTML=`
      <strong>${u.nome||"-"}</strong>
      <strong>${u.usuario||"-"}</strong>
      <span>${u.email}</span>
      <span>Grupo: ${u.papel}</span>
      <span style="color:${u.ativo!==false?"#2f6b2f":"#c0392b"}">
        ${u.ativo!==false?"Ativo":"Inativo"}
      </span>
    `;
    b.onclick=()=>editar(u);
    lista.appendChild(b);
  });

  const novo=document.createElement("button");
  novo.className="config-card";
  novo.innerHTML="‚ûï Criar novo usu√°rio";
  novo.onclick=criarNovo;
  lista.appendChild(novo);
}

/* EDITAR */
function editar(u){
  usuarioAtual = u;
  edit_nome.value     = u.nome || "";
  edit_usuario.value  = u.usuario || "";
  edit_email.value    = u.email;
  edit_email.disabled = true;
  edit_ativo.checked  = u.ativo !== false;
  preencherGrupos(u.papel);
  editor.classList.remove("hidden");
}

/* NOVO */
function criarNovo(){
  usuarioAtual = null;
  edit_nome.value     = "";
  edit_usuario.value  = "";
  edit_email.value    = "";
  edit_email.disabled = false;
  edit_ativo.checked  = true;
  preencherGrupos(null);
  editor.classList.remove("hidden");
}

function preencherGrupos(sel){
  edit_grupo.innerHTML="";
  grupos.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id;
    o.textContent=g.nome;
    if(g.id===sel) o.selected=true;
    edit_grupo.appendChild(o);
  });
}

function cancelar(){
  editor.classList.add("hidden");
}

/* SALVAR */
async function salvar(){
  const nome    = edit_nome.value.trim();
  const usuario = edit_usuario.value.trim();
  const email   = edit_email.value.trim();
  const papel   = edit_grupo.value;
  const ativo   = edit_ativo.checked;

  if(!nome) return mensagem("Informe o nome.","erro");
  if(!usuario) return mensagem("Informe o usu√°rio.","erro");

  if(!usuarioAtual){
    if(!email) return mensagem("Informe o email.","erro");

    try{
      const senhaTemp = Math.random().toString(36).slice(-10);
      const cred = await secondaryAuth.createUserWithEmailAndPassword(email, senhaTemp);

      await db.collection("usuarios").doc(cred.user.uid).set({
        nome,
        usuario,
        email,
        papel,
        ativo:true,
        criado_em: firebase.firestore.FieldValue.serverTimestamp()
      });

      await secondaryAuth.sendPasswordResetEmail(email);
      await secondaryAuth.signOut();

      mensagem("Usu√°rio criado com sucesso.");
      setTimeout(()=>location.reload(),1200);
    }catch(e){
      mensagem(e.message,"erro");
    }
    return;
  }

  await db.collection("usuarios")
    .doc(usuarioAtual._id)
    .update({ nome, usuario, papel, ativo });

  mensagem("Usu√°rio atualizado com sucesso.");
  setTimeout(()=>location.reload(),1200);
}

/* RESET */
function resetSenha(){
  auth.sendPasswordResetEmail(edit_email.value);
  mensagem("Email de redefini√ß√£o enviado.");
}

/* EXCLUIR */
async function excluir(){
  if(!usuarioAtual) return;
  if(!confirm(`Excluir ${usuarioAtual.nome}?`)) return;

  try{
    await db.collection("usuarios")
      .doc(usuarioAtual._id)
      .delete();

    mensagem("Usu√°rio exclu√≠do com sucesso.");
    setTimeout(()=>location.reload(),1200);
  }catch(e){
    mensagem(e.message,"erro");
  }
}
</script>

<script src="../login/logout.js"></script>

</body>
</html>
