<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Motor de Mensagens AutomÃ¡ticas</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCW-CuFDrOLO-dteckl_GrPTocmyS-IrzY",
    authDomain: "sitio-corrego-do-pinhal.firebaseapp.com",
    projectId: "sitio-corrego-do-pinhal"
  });
}
</script>
</head>

<body>

<script>
/* ======================================================
   MOTOR DE MENSAGENS AUTOMÃTICAS â€” FINAL
   ====================================================== */

const db = firebase.firestore();

/* ======================================================
   UTIL
   ====================================================== */
function normalizarData(d) {
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function render(template, vars) {
  return template.replace(/\{\{(\w+)\}\}/g, (_, k) => vars[k] ?? "");
}

/* ======================================================
   CONFIG
   ====================================================== */
async function carregarConfig() {
  const snap = await db.collection("config")
    .doc("mensagens_automaticas")
    .get();

  return snap.exists ? snap.data() : {};
}

/* ======================================================
   EXECUÃ‡ÃƒO
   ====================================================== */
async function executarMotor() {
  const cfg = await carregarConfig();
  const hoje = normalizarData(new Date());

  await vacinas(cfg, hoje);
  await partos(cfg, hoje);
  await coberturas(cfg, hoje);
  await aniversarios(cfg, hoje);
  await compras(cfg);
  await estoque(cfg);
}

/* ======================================================
   VACINAS
   ====================================================== */
async function vacinas(cfg, hoje) {
  if (!cfg.vacinas) return;

  const snap = await db.collection("vacinas").get();

  snap.forEach(doc => {
    const v = doc.data();
    if (!v.data_proxima_dose) return;

    const data = normalizarData(new Date(v.data_proxima_dose));
    const diff = Math.floor((data - hoje) / 86400000);

    if (diff === 0 && cfg.vacinas.pendentes?.ativo) {
      enviar(render(cfg.vacinas.pendentes.texto, { animal: v.animal }));
    }

    else if (diff < 0 && cfg.vacinas.atrasadas?.ativo) {
      enviar(render(cfg.vacinas.atrasadas.texto, {
        animal: v.animal,
        dias: Math.abs(diff)
      }));
    }
  });
}

/* ======================================================
   PARTOS â€” RÃ‰GUA COMPLETA (PRINT)
   ====================================================== */
async function partos(cfg, hoje) {
  if (!cfg.partos) return;

  const snap = await db.collection("vacas").get();

  snap.forEach(doc => {
    const v = doc.data();
    if (!v.data_parto_prevista) return;

    const data = normalizarData(new Date(v.data_parto_prevista));
    const dias = Math.floor((data - hoje) / 86400000);

    // OK (partos longe) â†’ nunca notifica
    if (dias >= 75) return;

    // FAIXAS (informativo, NÃƒO diÃ¡rio)
    if (dias >= 60 && cfg.partos.faixa_60?.ativo) {
      enviar(render(cfg.partos.faixa_60.texto, { animal: v.nome, dias }));
    }
    else if (dias >= 45 && cfg.partos.faixa_45?.ativo) {
      enviar(render(cfg.partos.faixa_45.texto, { animal: v.nome, dias }));
    }
    else if (dias >= 30 && cfg.partos.faixa_30?.ativo) {
      enviar(render(cfg.partos.faixa_30.texto, { animal: v.nome, dias }));
    }
    else if (dias >= 15 && cfg.partos.faixa_15?.ativo) {
      enviar(render(cfg.partos.faixa_15.texto, { animal: v.nome, dias }));
    }
    else if (dias > 0 && cfg.partos.faixa_1?.ativo) {
      enviar(render(cfg.partos.faixa_1.texto, { animal: v.nome, dias }));
    }

    // HOJE â†’ diÃ¡rio
    else if (dias === 0 && cfg.partos.hoje?.ativo) {
      enviar(render(cfg.partos.hoje.texto, { animal: v.nome }));
    }

    // ATRASADO â†’ diÃ¡rio
    else if (dias < 0 && cfg.partos.atrasado?.ativo) {
      enviar(render(cfg.partos.atrasado.texto, {
        animal: v.nome,
        dias: Math.abs(dias)
      }));
    }
  });
}

/* ======================================================
   COBERTURAS (24h)
   ====================================================== */
async function coberturas(cfg, hoje) {
  if (!cfg.coberturas?.ativo) return;

  const snap = await db.collection("coberturas").get();

  snap.forEach(doc => {
    const c = doc.data();
    if (!c.data) return;

    const data = normalizarData(new Date(c.data));
    const diff = Math.floor((hoje - data) / 86400000);

    if (diff === 1) {
      enviar(render(cfg.coberturas.texto, { animal: c.animal }));
    }
  });
}

/* ======================================================
   ANIVERSÃRIOS
   ====================================================== */
async function aniversarios(cfg, hoje) {
  if (!cfg.aniversarios?.ativo) return;

  const d = hoje.getDate();
  const m = hoje.getMonth() + 1;

  const snap = await db.collection("aniversarios").get();

  snap.forEach(doc => {
    const a = doc.data();
    if (a.dia === d && a.mes === m) {
      enviar(render(cfg.aniversarios.texto, { nome: a.nome }));
    }
  });
}

/* ======================================================
   ITENS A COMPRAR
   ====================================================== */
async function compras(cfg) {
  if (!cfg.compras?.ativo) return;

  const snap = await db.collection("compras")
    .where("comprado", "==", false)
    .get();

  if (!snap.empty) {
    enviar(render(cfg.compras.texto, { total: snap.size }));
  }
}

/* ======================================================
   ESTOQUE ZERO
   ====================================================== */
async function estoque(cfg) {
  if (!cfg.estoque_zero?.ativo) return;

  const snap = await db.collection("farmacia")
    .where("estoque", "==", 0)
    .get();

  if (!snap.empty) {
    enviar(render(cfg.estoque_zero.texto, { total: snap.size }));
  }
}

/* ======================================================
   ENVIO (stub)
   ====================================================== */
function enviar(msg) {
  console.log("ðŸ”” NOTIFICAÃ‡ÃƒO:", msg);
}

/* START */
window.addEventListener("load", () => {
  console.log("ðŸš€ Motor de mensagens iniciado");
  executarMotor();
});

</script>

</body>
</html>
